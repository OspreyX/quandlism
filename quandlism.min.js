(function(e){(function(){var t,n,r,i,s,o,u,a,f,l,c;i=e.quandlism={version:"0.2.0"},i.context=function(){var e,n,r,i,s,o,u,a,f,l,c,h,p,d=this;return n=new t,p=null,l=null,r=null,o=null,i=null,s=null,u=null,a=.8,h=.75,f=d3.dispatch("respond","adjust","toggle","refresh"),e=d3.scale.category20(),c=[],n.attachData=function(e){return c=e,o&&d3.select(o).datum(c),i&&d3.select(i).datum(c),s&&d3.select(s).datum(c),n},n.render=function(){return o&&d3.select(o).call(n.stage()),i&&d3.select(i).call(n.brush()),s&&d3.select(s).call(n.legend()),n},n.build=function(){return p=$(r).width(),l=$(r).height(),n},n.lines=function(e){return e==null?c:(c=e,n)},n.colorScale=function(t){return t==null?e:(e=t,n)},n.endPercent=function(e){return e==null?a:(a=e,n)},n.startPoint=function(e){return e==null?h:(h=e,n)},n.w=function(e){return e==null?p:(p=e,n)},n.h=function(e){return e==null?l:(l=e,n)},n.dom=function(e){return e==null?r:(r=e,n)},n.domstage=function(e){return e==null?o:(o=e,n)},n.dombrush=function(e){return e==null?i:(i=e,n)},n.domlegend=function(e){return e==null?s:(s=e,n)},n.domtooltip=function(e){return e==null?u:(u=e,n)},n.respond=_.throttle(function(){return f.respond.call(n,500)}),n.adjust=function(e,t){return f.adjust.call(n,e,t)},n.toggle=function(){return f.toggle.call(n)},n.refresh=function(){return f.refresh.call(n)},n.on=function(e,t){return t==null?f.on(e):(f.on(e,t),n)},d3.select(window).on("resize",function(){var e,t;d3.event.preventDefault();if(r){t=$(r).width(),e=$(r).height();if(p!==t||l!==e)p=t,l=e,n.respond()}}),n},t=function(){function e(){}return e}(),n=t.prototype=i.context.prototype,s=0,a=0,u=0,f={w:.87,h:.6},o={w:.87,h:.1},l={w:.87,h:.15},c={w:.12,h:.6},r=function(){function e(){}return e}(),n.line=function(e){var t,n,i,s,o,u,f=this;return i=new r(t),t=this,s=e.name,o=e.values.reverse(),n=a++,u=!0,i.extent=function(e,t){var n,r,i,s,o;n=e!=null?e:0,s=t!=null?t:this.length()-1,i=Infinity,r=-Infinity;if(!this.visible())return[i,r];while(n<=s){o=this.valueAt(n);if(o==null){n++;continue}o<i&&(i=o),o>r&&(r=o),n++}return[i,r]},i.dates=function(e,t){var n,r,i,s,u;s=o.slice(e,t+1||9e9),u=[];for(r=0,i=s.length;r<i;r++)n=s[r],u.push(n.date);return u},i.length=function(){return o.length},i.valueAt=function(e){return o[e]!=null?o[e].num:null},i.dateAt=function(e){return o[e]!=null?o[e].date:null},i.drawPoint=function(e,t,n,r,i,s){if(this.visible())return t.beginPath(),t.arc(n(i),r(this.valueAt(i)),s,0,Math.PI*2,!0),t.fillStyle=e,t.fill(),t.closePath()},i.drawPath=function(e,t,n,r,i,s,o){var u,a;if(this.visible()){t.beginPath();for(u=a=i;i<=s?a<=s:a>=s;u=i<=s?++a:--a)t.lineTo(n(u),r(this.valueAt(u)));return t.lineWidth=o,t.strokeStyle=e,t.stroke(),t.closePath()}},i.toggle=function(){var e;return e=!this.visible(),this.visible(e),e},i.id=function(e){return e==null?n:(n=e,i)},i.name=function(e){return e==null?s:(s=e,i)},i.values=function(e){return e==null?o:(o=e,i)},i.visible=function(e){return e==null?u:(u=e,i)},i},n.stage=function(){var e,t,n,r,i,s,o,a,h,p,d,v,m,g,y,b,w,E,S,x,T=this;return n=this,t=null,o=[],d=Math.floor(n.w()*f.w),s=Math.floor(n.h()*f.h),b=d3.scale.linear(),g=d3.time.scale(),x=d3.scale.linear(),v=d3.svg.axis().orient("bottom").scale(g),E=d3.svg.axis().orient("left").scale(x),S=null,m=null,a=10,i=[],w=0,y=d,p=10,e=null,r=null,h=function(h){var T,N,C,k,L,A;o=h.datum(),t="canvas-stage-"+ ++u,S==null&&(S=h.append("svg"),S.attr("class","y axis"),S.attr("id","y-axis-"+t),S.attr("width",n.w()*c.w),S.attr("height","100%")),e=h.append("canvas"),e.attr("width",d),e.attr("height",s),e.attr("class","stage"),e.attr("id",t),r=e.node().getContext("2d"),m==null&&(m=h.append("svg"),m.attr("class","x axis"),m.attr("id","x-axis-"+t),m.attr("width",n.w()*l.w),m.attr("height",n.h()*l.h)),E.tickSize(5,3,0),v.tickSize(5,3,0),v.tickFormat(d3.time.format("%b %d, %Y")),A=function(){var e;i=n.utility().getExtent(o,w,y),e=n.utility().parseDate(o[0].dateAt(0)),x.domain([i[0],i[1]]),x.range([s-a,a]),b.domain([w,y]),b.range([a,d-a]),g.domain([e(o[0].dateAt(w)),e(o[0].dateAt(y))]),g.range([a,d-a])},C=function(){var e,t;return S.selectAll("*").remove(),t=S.append("g"),t.attr("transform","translate("+(n.w()*c.w-1)+", 10)"),t.call(E),m.selectAll("*").remove(),e=m.append("g"),e.call(v)},N=function(e){var t,i,u,a,f,l,c;C(),r.clearRect(0,0,d,s),e=e!=null?e:-1;for(i=f=0,c=o.length;f<c;i=++f){u=o[i],a=i===e?3:1.5;if(y-w<=p){u.drawPath(n.utility().getColor(i),r,b,x,w,y,a);for(t=l=w;w<=y?l<=y:l>=y;t=w<=y?++l:--l)u.drawPoint(n.utility().getColor(i),r,b,x,t,3)}else y===w?u.drawPoint(n.utility().getColor(i),r,b,x,w,3):u.drawPath(n.utility().getColor(i),r,b,x,w,y,a)}},L=function(e){var t,i,s,u,a,f,l,c,h,p,d,v,m,g;t=n.utility().getPixelRGB(e,r),s=_.indexOf(n.colorScale().range(),t);if(s!==-1)return{x:e[0],color:t,line:o[s]};i=[];for(u=l=p=e[0]-3,d=e[0]+3;p<=d?l<=d:l>=d;u=p<=d?++l:--l)for(a=c=v=e[1]-3,m=e[1]+3;v<=m?c<=m:c>=m;a=v<=m?++c:--c)(u!==e[0]||a!==e[1])&&i.push([u,a]);for(f=h=0,g=i.length-1;0<=g?h<=g:h>=g;f=0<=g?++h:--h){t=n.utility().getPixelRGB(i[f],r),s=_.indexOf(n.colorScale().range(),t);if(s!==-1)return{x:i[f][0],color:t,line:o[s]}}return!1},k=function(e,t,i){var s;$(n.domtooltip()).html("<span style='color: "+i+";'>"+t.name()+"</span>: "+n.utility().formatNumberAsString(t.valueAt(e))+"  on "+t.dateAt(e)),N(t.id()),s=y-w<=p?5:3,t.drawPoint(i,r,b,x,e,s)},T=function(){$(n.domtooltip()).text(""),N()},n.dombrush()||A()&&N(),n.on("respond.stage",function(){r.clearRect(0,0,d,s),d=Math.floor(n.w()*f.w),s=Math.floor(n.h()*f.h),e.attr("width",d),e.attr("height",s),S.attr("width",Math.floor(n.w()*c.w)),m.attr("width",Math.floor(n.w()*l.w)),A(),N()}),n.on("adjust.stage",function(e,t){w=e>0?e:0,y=o[0].length()>t?t:o[0].length()-1,A(),N(),console.log(v.tickValues())}),n.on("toggle.stage",function(){A(),N()}),n.on("refresh.stage",function(){o=h.datum(),n.dombrush()||N()}),n.domtooltip()!=null&&d3.select("#"+t).on("mousemove",function(e){var t;t=L(d3.mouse(this)),t!==!1?k(Math.round(b.invert(t.x)),t.line,t.color):T()})},h.padding=function(e){return e==null?a:(a=e,h)},h.canvasId=function(e){return e==null?t:(t=e,h)},h.width=function(e){return e==null?d:(d=e,h)},h.height=function(e){return e==null?s:(s=e,h)},h.xScale=function(e){return e==null?b:(b=e,h)},h.yScale=function(e){return e==null?x:(x=e,h)},h.xEnd=function(e){return e==null?y:(y=e,h)},h.xStart=function(e){return e==null?w:(w=e,h)},h.threshold=function(e){return e==null?p:(p=e,h)},h},n.brush=function(){var e,t,n,r,i,s,a,f,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_=this;return a=this,v=a.h()*o.h,m=v,x=a.w()*o.w,T=x,n=null,r=null,d=10,A=null,O=null,L=d3.scale.linear(),k=d3.time.scale(),M=d3.scale.linear(),i=null,f=null,N=d3.svg.axis().orient("bottom").scale(k),C=null,s=null,p=[],g=[],E=10,h=!1,c=!0,w=!1,y=6,b=0,e=0,S=null,t=function(t){var _,D,P,H,B,j,F,I,q,R;return g=t.datum(),s="canvas-brush-"+ ++u,i=t.append("canvas").attr("width",x).attr("height",v).attr("class","brush").attr("id",s),f=i.node().getContext("2d"),C==null&&(C=t.append("svg"),C.attr("class","x axis"),C.attr("id","x-axis-"+s),C.attr("height",a.h()*l.h),C.attr("width",a.w()*l.w)),N.tickSize(5,3,0),q=function(){var e;p=a.utility().getExtent(g,null,null),e=a.utility().parseDate(g[0].dateAt(0)),M.domain([p[0],p[1]]),M.range([v,0]),L.domain([0,g[0].length()-1]),L.range([0,x]),k.range([0,x]),k.domain([e(g[0].dateAt(0)),e(g[0].dateAt(g[0].length()-1))]),b=Math.floor(L(y))},I=function(){A=L(a.startPoint()*g[0].length()),O=A,n=x-A,r=n,n<b&&(n=b,r=n,A=x-n,O=A)},R=function(){D(),H(),j()},D=function(){f.clearRect(0,0,T,m),i.attr("width",x).attr("height",v)},B=function(){var e;return C.selectAll("*").remove(),e=C.append("g"),e.call(N)},H=function(){var e,t,n,r,i;n=g[0].length()<=E;for(e=r=0,i=g.length;r<i;e=++r)t=g[e],t.drawPath(a.utility().getColor(e),f,L,M,0,g[0].length(),1),n&&t.drawPoint(a.utility().getColor(e),f,L,M,e,2)},j=function(){f.strokeStyle="rgba(207, 207, 207, 0.55)",f.beginPath(),f.fillStyle="rgba(207, 207, 207, 0.55)",f.fillRect(A,0,n,v),f.lineWidth=1,f.lineTo(A,v),f.closePath(),f.beginPath(),f.fillStyle="#CFCFCF",f.fillRect(A-d,0,d,v),f.closePath(),f.beginPath(),f.fillStyle="#CFCFCF",f.fillRect(A+n,0,d,v),f.closePath()},_=function(){return g[0].length()-1<=y?(A=0,r=x,n=x,c=!1):c=!0},P=function(){var e,t;e=L.invert(A),t=L.invert(A+n),a.adjust(Math.ceil(e),Math.ceil(t))},F=function(){h=!1,w=!1,e=0,O=A,r=n},q(),_(),c&&I(),B(),P(),setInterval(R,50),a.on("respond.brush",function(){m=v,T=x,v=a.h()*o.h,x=a.w()*o.w,A=A/T*x,O=O/T*x,n=n/T*x,r=n,q()}),a.on("refresh.brush",function(){g=t.datum(),q(),_(),c&&I(),P()}),a.on("toggle.brush",function(){q()}),i.on("mousedown",function(t){var r;d3.event.preventDefault(),r=d3.mouse(this),S=r[0],r[0]>=A-d&&r[0]<A?(w=!0,e=-1):r[0]>A+n&&r[0]<=A+n+d?(w=!0,e=1):r[0]<=n+A&&r[0]>=A&&(h=!0)}),i.on("mouseup",function(e){F()}),i.on("mouseout",function(e){F()}),i.on("mousemove",function(t){var i,s;s=d3.mouse(this);if(h||w){i=s[0]-S;if(h&&c)A=O+i;else if(w){if(e!==0&&e!==-1&&e!==1)throw"Error: Unknown stretching direction";n=e===-1?r-i:r+i,e===-1&&(A=O+i),n<=b&&(e===-1&&(A+=n-b),n=b)}P()}})},t.xAxis=function(e){return e==null?N:(N=e,t)},t.threshold=function(e){return e==null?E:(E=e,t)},t.stretchLimit=function(e){return e==null?y:(y=e,t)},t.handleWidth=function(e){return e==null?d:(d=e,t)},t},n.xaxis=function(){var e,t,n,r,i,s,o,u,a,f,c,h=this;return n=this,f=n.w()*l.w,i=n.h()*l.h,a=d3.time.scale().range([0,f]),t=d3.svg.axis().scale(a),r=[],e=!1,o=[],s=null,u=null,c=function(h){var p,d;s=h.attr("id"),o=h.datum(),t.tickSize(5,3,0),d=function(){var e;return c.remove(),e=h.append("svg"),e.attr("width",f),e.attr("height",i),e.append("g"),e.attr("transform","translate(0, 27)"),e.call(t)},p=function(){return r=[o[0].dateAt(0),o[0].dateAt(o[0].length()-1)],u=n.utility().parseDate(o[0].dateAt(0)),a.domain([u(r[0]),u(r[1])]),t.tickFormat(d3.time.format("%b %d, %Y")),t.ticks(Math.floor(f/150,0,0)),a.range([0,f])},p(),d(),n.on("respond.xaxis-"+s,function(){return f=n.w()*l.w,t.ticks(Math.floor(f/150,0,0)),a.range([0,f]),d()}),n.on("refresh.xaxis-"+s,function(){return o=h.datum(),p(),d()}),e&&n.on("adjust.xaxis-"+s,function(e,t){return t=t>o[0].length()-1?o[0].length()-1:t,e=e<0?0:e,r=[o[0].dateAt(e),o[0].dateAt(t)],a.domain([u(r[0]),u(r[1])]),d()})},c.remove=function(){return d3.select("#"+s).selectAll("svg").remove()},c.active=function(t){return t?(e=t,c):e},d3.rebind(c,t,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},n.yaxis=function(){var e,t,n,r,i,s,o,u,a,f,l,h=this;return t=this,u=t.w()*c.w,r=t.h()*c.h,o=d3.scale.linear().range([r,0]),e=d3.svg.axis().scale(o),s=[],n=[],f=null,a=null,i=null,l=function(h){var p,d;i=h.attr("id"),s=h.datum(),e.ticks(Math.floor(r/25,0,0)),e.tickSize(5,3,0),d=function(){var i,c;return n=t.utility().getExtent(s,f,a),o.domain([n[0],n[1]]),l.remove(),c=h.append("svg"),c.attr("width",u),c.attr("height","100%"),i=c.append("g"),i.attr("transform","translate("+(u-1)+", 0)"),i.attr("width",u),i.attr("height",r),i.call(e)},p=function(){a=s[0].length()-1,f=Math.floor(s[0].length()*t.endPercent())},p(),d(),t.on("toggle.y-axis-"+i,function(){d()}),t.on("refresh.y-axis-"+i,function(){s=h.datum(),p(),d()}),t.on("respond.y-axis-"+i,function(){u=t.w()*c.w,r=t.h()*c.h,e.ticks(Math.floor(r/25,0,0)),o.range([r,0]),d()}),t.on("adjust.y-axis-"+i+"}",function(e,t){f=e>0?e:0,a=t<s[0].length()?t:s[0].length(),d()})},l.remove=function(e){d3.select("#"+i).selectAll("svg").remove()},d3.rebind(l,e,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},n.legend=function(){var e,t,n,r;return e=this,n=null,r=[],t=function(t){var i=this;return r=t.datum(),t.selectAll("li").remove(),n=t.selectAll("li").data(r).enter().append("li").append("a").attr("href","javascript:;").attr("data-line-id",function(e){return e.id()}).attr("style",function(t){return"background-color: "+e.utility().getColor(t.id())}).text(function(e){return e.name()}),e.on("refresh.legend",function(){return r=t.datum()}),t.selectAll("a").on("click",function(t,n){var i,s,o;i=d3.event,s=i.target,o=s.getAttribute("data-line-id"),i.preventDefault(),r[o]!=null&&(r[o].toggle()===!1?$(s).addClass("off").attr("style","background-color: none;"):$(s).removeClass("off").attr("style","background-color: "+e.utility().getColor(o)),e.toggle())})},t},n.utility=function(){var e,t,n=this;return e=this,t=function(){},t.createLines=function(t){var n,r,i,s,o,u,a;r=t.columns.slice(1),s=_.map(r,function(e,n){return _.map(t.data,function(e){return{date:e[0],num:+e[n+1]}})});if(!e.lines().length)o=_.map(r,function(t,n){return e.line({name:t,values:s[n]})});else{o=e.lines();for(n=u=0,a=o.length;u<a;n=++u)i=o[n],i.values(s[n].reverse())}return o},t.getExtent=function(e,t,n){var r,i;return r=function(){var r,s,o;o=[];for(r=0,s=e.length;r<s;r++)i=e[r],o.push(i.extent(t,n));return o}(),[d3.min(r,function(e){return e[0]}),d3.max(r,function(e){return e[1]})]},t.getColor=function(t){var n;return n=e.colorScale(),n(t)},t.formatNumberAsString=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},t.getPixelRGB=function(e,t){var n,r;return n=t.getImageData(e[0],e[1],1,1).data,r=d3.rgb(n[0],n[1],n[2]),r.toString()},t.dateFormat=function(e){var t,n;n=e.split("-").length-1;switch(n){case-1:t="%Y";break;case 2:t="%Y-%m-%d";break;default:throw"Unknown date format: "+n+" "+e}return t},t.parseDate=function(e){var t;return t=this.dateFormat(e),d3.time.format(t).parse},t}}).call(this)})(this);