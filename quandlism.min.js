(function(e){function o(){}function g(e){this.context=e}var t=e.quandlism={version:"0.1.0"},r=0;t.context=function(){function m(){return r=$(i).width(),h=$(i).height(),e}var e=new o,t="daily",n="none",r=h=null,i=null,s=null,u=null,a=null,l=null,c=d3.dispatch("respond","adjust","toggle","refresh","x_axis_refresh"),p=d3.scale.category20(),d=.8,v;return e.render=function(){return l&&d3.select(l).call(this.stage()),a&&d3.select(a).call(this.brush()),s&&d3.select(s).call(this.legend()),m()},e.attachData=function(e){return l&&(stage=d3.select(l).datum(e),stage.select(".x")&&stage.select(".x").datum(e),stage.select(".y")&&stage.select(".y").datum(e)),a&&(brush=d3.select(a).datum(e),brush.select(".x")&&brush.select(".x").datum(e)),s&&d3.select(s).datum(e),m()},e.prepare=function(){return f=0,m()},e.trans=function(e){return arguments.length?(n=e,m()):n},e.frequency=function(e){return arguments.length?(t=e,m()):t},e.w=function(e){return arguments.length?(r=e,m()):r},e.h=function(e){return arguments.length?(h=e,m()):h},e.dom=function(e){return arguments.length?(i=e,m()):i},e.domlegend=function(e){return arguments.length?(s=e,m()):s},e.domtooltip=function(e){return arguments.length?(u=e,m()):u},e.domstage=function(e){return arguments.length?(l=e,m()):l},e.dombrush=function(e){return arguments.length?(a=e,m()):a},e.colorScale=function(e){return arguments.length?(p=e,m()):p},e.endPercentage=function(e){return arguments.length?(d=e,m()):d},e.refresh=function(){c.refresh.call(e)},e.respond=_.throttle(function(){c.respond.call(e)},500),e.adjust=function(t,n){c.adjust.call(e,t,n)},e.toggle=function(){c.toggle.call(e)},e.x_axis_refresh=function(){c.x_axis_refresh.call(e)},e.on=function(t,n){return arguments.length<2?c.on(t):(c.on(t,n),e)},d3.select(window).on("resize",function(){d3.event.preventDefault();if(i!=null){w0=$(i).width(),h0=$(i).height();if(r!=w0||h!=h0)r=w0,h=h0,e.respond()}}),m()};var u=o.prototype=t.context.prototype,a=0,f=0,l=0,c={w:.85,h:.6},p={w:.85,h:.1},d={w:.85,h:.15},v={w:.1,h:.6},y=g.prototype;t.line=g,u.line=function(e){var t=this,n=new g(t),r=e.name,s=e.values.reverse(),o=f++,u=!0;return n.id=function(e){return arguments.length?(o=e,n):o},n.visible=function(e){return arguments.length?(u=e,n):u},n.name=function(e){return arguments.length?(r=e,n):r},n.drawPoint=function(e,t,n,r,i,s){this.visible()&&(t.beginPath(),t.arc(n(i),r(this.valueAt(i)),s,0,Math.PI*2,!0),t.fillStyle=e,t.fill(),t.closePath())},n.drawPath=function(e,t,n,r,s,o,u){if(this.visible()){t.beginPath();for(i=s;i<=o;i++)t.lineTo(n(i),r(this.valueAt(i)));t.lineWidth=u,t.strokeStyle=e,t.stroke(),t.closePath()}},n.extent=function(e,t){var n=0,r=this.length()-1,i=Infinity,s=-Infinity,o;if(!this.visible())return[i,s];e!=null&&(n=e),t!=null&&(r=t);while(n<=r){o=this.valueAt(n);if(_.isUndefined(o)||_.isNull(o)){n++;continue}o<i&&(i=o),o>s&&(s=o),n++}return[i,s]},n.toggle=function(){return visibility=!this.visible(),this.visible(visibility),visibility},n.startDate=function(){return s[0].date},n.endDate=function(){return s[this.length()-1].date},n.valueAt=function(e){return typeof s[e]=="undefined"?null:s[e].num},n.dateAt=function(e){return typeof s[e]=="undefined"?null:s[e].date},n.values=function(){return s},n.length=function(){return s.length},n},u.stage=function(){function T(h){function N(t){m=e.utility().getExtent(r,w,E),f.domain([m[0],m[1]]),f.range([o-u,u]),a.domain([w,E]),a.range([u,s-u]),y.clearRect(0,0,s,o),t=_.isUndefined(t)?-1:t,_.each(r,function(n,r){lineWidth=r==t?3:1.5,E-w<=p?(n.drawPath(e.utility().getColor(r),y,a,f,w,E,lineWidth),_.each(_.range(w,E+1),function(t){n.drawPoint(e.utility().getColor(r),y,a,f,t,3)})):w==E?n.drawPoint(e.utility().getColor(r),y,a,f,w,3):n.drawPath(e.utility().getColor(r),y,a,f,w,E,lineWidth)})}function C(t,n,r){$(e.domtooltip()).html('<span style="color: '+r+';">'+t.name()+"</span> : "+t.valueAt(n)+""),N(t.id()),t.drawPoint(r,y,a,f,n,E-w<=p?5:3)}function L(){$(e.domtooltip()).text("")}function A(t){hex=e.utility().getPixelRGB(t,y),i=_.indexOf(e.colorScale().range(),hex);if(i!==-1)return{x:t[0],color:hex,line:r[i]};hitMatrix=[];for(j=t[0]-3;j<=t[0]+3;j++)for(k=t[1]-3;k<=t[1]+3;k++)(j!=t[0]||k!=t[1])&&hitMatrix.push([j,k]);for(n=0;n<hitMatrix.length;n++){hex=e.utility().getPixelRGB(hitMatrix[n],y),i=_.indexOf(e.colorScale().range(),hex);if(i!==-1)return{x:hitMatrix[n][0],color:hex,line:r[i]}}return!1}r=h.datum(),t="canvas-stage-"+ ++l,x||(x=h.append("div").datum(r).attr("width",e.w()*v.w).attr("height",e.h()*v.h).attr("class","y axis").attr("id","y-axis-"+t).call(e.yaxis().active(!0).orient("left"))),h.append("canvas").attr("width",s).attr("height",o).attr("class","stage").attr("id",t),S||(S=h.append("div").datum(r).attr("width",e.w()*d.w).attr("height",e.h()*d.h).attr("class","x axis").attr("id","x-axis-"+t).call(e.axis().active(!0))),g=h.select("#"+t),y=g.node().getContext("2d"),E||(E=r[0].length()),w||(w=Math.floor(r[0].length()*e.endPercentage())),N(),b=e.colorScale().range(),e.on("respond.stage",function(){y.clearRect(0,0,s,o),s=Math.floor(e.w()*c.w),o=Math.floor(e.h()*c.h),g.attr("width",s).attr("height",o),N()}),e.on("adjust.stage",function(e,t){w=e>0?e:0,E=t<r[0].length()?t:r[0].length()-1,N()}),e.on("toggle.stage",function(){N()}),e.on("refresh.stage",function(){r=h.datum(),E=r[0].length(),w=Math.floor(r[0].length()*e.endPercentage()),N()}),e.domtooltip()&&d3.select("#"+t).on("mousemove",function(e){(hit=A(d3.mouse(this)))?C(hit.line,Math.round(a.invert(hit.x)),hit.color):(L(),N())}),T.threshold=function(e){return arguments.length?(p=e,T):p},T.canvasPadding=function(e){return arguments.length?(u=e,T):u},T.end=function(e){return arguments.length?(E=e,T):E},T.start=function(e){return arguments.length?(w=e,T):w},T.xAxis=function(e){return arguments.length?(S=e,T):S},T.yAxis=function(e){return arguments.length?(x=e,T):x}}var e=this,t=null,r=[],s=Math.floor(e.w()*c.w),o=Math.floor(e.h()*c.h),u=10,a=d3.scale.linear(),f=d3.scale.linear(),h=null,p=10,m=null,g=null,y=null,b=[],w=null,E=null,S=null,x=null;return T},u.brush=function(){function x(w){function x(){g=e.utility().getExtent(v,null,null),u.domain([g[0],g[1]]),u.range([t,0]),o.domain([0,v[0].length()-1]),o.range([0,n])}function T(){N(),C(),k()}function N(){h.clearRect(0,0,width0,height0),a.attr("width",n).attr("height",t)}function C(){st=0,en=v[0].length(),showPoints=en-st<=E,_.each(v,function(t,n){t.drawPath(e.utility().getColor(n),h,o,u,st,en,1),showPoints&&_.each(_.range(st,en),function(r){t.drawPoint(e.utility().getColor(n),h,o,u,r,2)})})}function k(){h.beginPath(),h.fillStyle="rgba(207, 207, 207, 0.55)",h.fillRect(s,0,r,t),h.lineWidth=1,h.lineTo(s,t),h.closePath(),h.beginPath(),h.lineWidth=i,h.strokeStyle="#CFCFCF",h.strokeRect(s,0,r,t),h.closePath()}function L(){x1=o.invert(s),x2=o.invert(s+r),e.adjust(Math.ceil(x1),Math.ceil(x2))}v=w.datum(),f="canvas-brush-"+ ++l,w.append("canvas").attr("width",n).attr("height",t).attr("class","brush").attr("id",f),c||(c=w.append("div").datum(v).attr("class","x axis").attr("width",e.w()*d.w).attr("height",e.h()*d.h).attr("id","x-axis-"+f).call(e.axis())),a=w.select("#"+f),h=a.node().getContext("2d"),x(),L(),e.on("respond.brush",function(){height0=t,width0=n,t=e.h()*p.h,n=e.w()*p.w,r=Math.ceil(r/width0*n),s=Math.ceil(s/width0*n),start0=Math.ceil(start0/width0*n),x()}),e.on("toggle.brush",function(){x()}),e.on("refresh.brush",function(){v=w.datum(),s=Math.ceil(n*e.endPercentage()),start0=s,r=Math.ceil(n*.2),brushWidth0=r,x()}),a.on("mousedown",function(e){m=d3.mouse(this),m[0]>=s&&m[0]<=s+i?(b=!0,stretchingHandle=-1,S=m[0]):m[0]>=s+r&&m[0]<=s+r+i?(b=!0,stretchingHandle=1,S=m[0]):m[0]<=r+s&&m[0]>=s&&(y=!0,S=m[0])}),a.on("mouseup",function(e){y=b=!1,stretchingDir=0,start0=s,brushWidth0=r}),a.on("mousemove",function(e){m=d3.mouse(this);if(y||b){if(y)dragDiff=m[0]-S,s=start0+dragDiff;else if(b){dragDiff=m[0]-S;if(stretchingHandle==-1)s=start0+dragDiff,r=brushWidth0-dragDiff;else{if(stretchingHandle!=1)throw"Error: Which direction?";r=brushWidth0+dragDiff}}L()}}),setInterval(T,50)}var e=this,t=height0=Math.floor(e.h()*p.h),n=width0=Math.floor(e.w()*p.w),r=brushWidth0=Math.ceil(n*.2),i=10,s=start0=Math.ceil(n*e.endPercentage()),o=d3.scale.linear(),u=d3.scale.linear(),a=null,f,c=null,h=null,v=[],g=[],y=!1,b=!1,w=0,E=10,S=0;return x.xAxis=function(e){return arguments.length?(c=e,x):c},x},u.axis=function(){function f(u){function l(){f.remove();var e=u.append("svg").attr("width",t).attr("height",n).append("g").attr("transform","translate(0,27)").call(i)}function c(){extent=[o[0].dateAt(0),o[0].dateAt(o[0].length()-1)],parseDate=e.utility().parseDate(o[0].dateAt(0)),r.domain([parseDate(extent[0]),parseDate(extent[1])]),i.tickFormat(d3.time.format("%b %d, %Y")),i.ticks(Math.floor(t/150),0,0),r.range([0,t])}a=u.attr("id"),o=u.datum(),c(),l(),e.on("respond.axis-"+a,function(){t=e.w()*d.w,i.ticks(Math.floor(t/150),0,0),r.range([0,t]),l()}),e.on("refresh.axis-"+a,function(){o=u.datum(),c(),l()}),s&&e.on("adjust.axis-"+a,function(e,t){t=t>o[0].length()-1?o[0].length()-1:t,e=e<0?0:e,extent=[o[0].dateAt(e),o[0].dateAt(t)],r.domain([parseDate(extent[0]),parseDate(extent[1])]),l()})}var e=this,t=e.w()*d.w,n=e.h()*d.h,r=d3.time.scale().domain([0,length]).range([0,t]),i=d3.svg.axis().scale(r),s=!1,o=null,u,a;return f.remove=function(){d3.select("#"+a).selectAll("svg").remove()},f.active=function(e){return arguments.length?(s=e,f):s},f.data=function(e){return arguments.length?(u=e,f):u},f.lines=function(e){return arguments.length?(o=e,f):o},d3.rebind(f,i,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},u.yaxis=function(){function c(u){function h(){o=e.utility().getExtent(s,a,f),r.domain([o[0],o[1]]),c.remove();var l=u.append("svg").attr("width",n).attr("height",t).append("g").attr("transform","translate("+n*.75+",0)").attr("height",t).attr("width",n).call(i)}function p(){c.endPoint(s[0].length()-1),c.startPoint(Math.floor(s[0].length()*e.endPercentage()))}l=u.attr("id"),s=u.datum(),i.ticks(Math.floor(t/50),0,0),p(),h(),e.on("respond.y-axis-"+l,function(){n=e.w()*v.w,t=e.h()*v.h,i.ticks(Math.floor(t/50),0,0),r.range([t,0]),h()}),e.on("adjust.y-axis-"+l,function(e,t){c.startPoint(e>0?e:0),c.endPoint(t<s[0].length()?t:s[0].length()-1),h()}),e.on("toggle.y-axis-"+l,function(){h()}),e.on("refresh.y-axis-"+l,function(){s=u.datum(),p(),h()})}var e=this,t=Math.floor(e.h()*v.h),n=Math.floor(e.w()*v.w),r=d3.scale.linear().range([t,0]),i=d3.svg.axis().scale(r),s=null,o=null,u=null,a=null,f=null,l;return c.remove=function(){d3.select("#"+l).selectAll("svg").remove()},c.active=function(e){return arguments.length?(active=e,c):active},c.lines=function(e){return arguments.length?(s=e,c):s},c.startPoint=function(e){return arguments.length?(a=e,c):a},c.endPoint=function(e){return arguments.length?(f=e,c):f},d3.rebind(c,i,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},u.legend=function(){function r(r){n=r.datum(),r.selectAll("li").remove(),t=r.selectAll("li").data(n),t.enter().append("li").attr("style",function(t){return"background-color: "+e.utility().getColor(t.id())}).append("a").attr("href","javascript:;").attr("data-line-id",function(e){return e.id()}).text(function(e){return e.name()}),t.exit().remove(),e.on("refresh.legend",function(){n=r.datum()}),r.on("click",function(t,r){evt=d3.event,evt.preventDefault(),line_id=evt.target.getAttribute("data-line-id"),vis=n[line_id].toggle(),e.toggle()})}var e=this,t=null,n=null;return r},u.utility=function(){function t(){}var e=this;return t.dateFormat=function(e){dateString="",hyphenCount=e.split("-").length-1;switch(hyphenCount){case-1:dateString="%Y";break;case 2:dateString="%Y-%m-%d";break;default:throw"Unknown date format: "+hyphenCount+e}return dateString},t.getExtent=function(e,t,n){return exes=_.map(e,function(e,r){return e.extent(t,n)}),[d3.min(exes,function(e){return e[0]}),d3.max(exes,function(e){return e[1]})]},t.createLines=function(t){return keys=_.without(t.columns,_.first(t.columns)),lines=_.map(keys,function(n,r){return e.line({name:n,values:_.map(t.data,function(e){return{date:e[0],num:+e[r+1]}})})}),lines},t.parseDate=function(e){return dateString=this.dateFormat(e),d3.time.format(dateString).parse},t.getPixelRGB=function(e,t){return px=t.getImageData(e[0],e[1],1,1).data,rgb=d3.rgb(px[0],px[1],px[2]),rgb.toString()},t.getColor=function(t){return s=e.colorScale(),s(t)},t}})(this);