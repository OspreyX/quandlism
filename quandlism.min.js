(function(e){(function(){var t,n,r,i,s,o,u,a,f,l,c;i=e.quandlism={version:"0.4.0"},i.context=function(){var e,n,r,i,s,o,a,f,l,c,h,p,d,v=this;return n=new t,d=null,l=null,r=null,o=null,i=null,s=null,a=null,h=0,p=.75,f=d3.dispatch("respond","adjust","toggle","refresh"),e=["#e88033","#4eb15d","#c45199","#6698cb","#6c904c","#e9563b","#9b506f","#d2c761","#4166b0","#44b1ae"],c=[],n.attachData=function(t){var r,u,a,f;if(!c.length){n.addColorsIfNecessary(t);for(r=a=0,f=t.length;a<f;r=++a)u=t[r],u.color(e[r])}return c=t,o&&d3.select(o).datum(c),i&&d3.select(i).datum(c),s&&c.length>1&&d3.select(s).datum(c),n},n.render=function(){return o&&d3.select(o).call(n.stage()),i&&d3.select(i).call(n.brush()),s&&c.length>1&&d3.select(s).call(n.legend()),n},n.build=function(){return d=$(r).width(),l=$(r).height(),n},n.setupWithContainer=function(e,t){var s,a,f;if(!e.length)throw"Invalid container";return s=t!=null?t:!0,e.children().remove(),e.attr("id")==null&&e.attr("id","quandlism-"+ ++u),r="#"+e.attr("id"),f="quandlism-stage-"+ ++u,e.append("<div class='stage' id='"+f+"'></div>"),o="#"+f,s&&(a="quandlism-brush-"+ ++u,e.append("<div class='brush' id='"+a+"'></div>"),i="#"+a),n},n.legendWithSelector=function(e){if(!e.length)throw"Invalid container";return e.attr("id")||e.attr("id","quandlism-legend-"+ ++u),s="#"+e.attr("id"),n},n.addColorsIfNecessary=function(t){var n,r,i,s;r=t.length-e.length;if(r<0)return;n=.1,i=0;while(i<r)s=d3.rgb(e[i]).brighter(n),e.push(s.toString()),i++},n.lines=function(e){return e?(c=e,n):c},n.colorList=function(t){return t==null?e:(e=t,n)},n.startPoint=function(e){return e==null?p:(p=e,n)},n.w=function(e){return e==null?d:(d=e,n)},n.h=function(e){return e==null?l:(l=e,n)},n.dom=function(e){return e==null?r:(r=e,n)},n.domstage=function(e){return e==null?o:(o=e,n)},n.dombrush=function(e){return e==null?i:(i=e,n)},n.domlegend=function(e){return e==null?s:(s=e,n)},n.padding=function(e){return e==null?h:(h=e,n)},n.respond=_.throttle(function(){return f.respond.call(n,500)}),n.adjust=function(e,t){return f.adjust.call(n,e,t)},n.toggle=function(){return f.toggle.call(n)},n.refresh=function(){return f.refresh.call(n)},n.on=function(e,t){return t==null?f.on(e):(f.on(e,t),n)},d3.select(window).on("resize",function(){var e,t;d3.event.preventDefault();if(r){t=$(r).width(),e=$(r).height();if(d!==t||l!==e)d=t,l=e,n.respond()}}),n},t=function(){function e(){}return e}(),n=t.prototype=i.context.prototype,s=0,a=0,u=0,c=40,l={h:.1},o={h:.15},f={h:.65},r=function(){function e(){}return e}(),n.line=function(e){var t,n,i,s,o,u,f,l=this;return s=new r,n=this,o=e.name,u=e.values.reverse(),i=a++,f=!0,t="#000000",s.extent=function(e,t){var n,r,i,s,o;n=e!=null?e:0,s=t!=null?t:this.length()-1,i=Infinity,r=-Infinity;if(!this.visible())return[i,r];while(n<=s){o=this.valueAt(n);if(o==null){n++;continue}o<i&&(i=o),o>r&&(r=o),n++}return[i,r]},s.dates=function(e,t){var n,r,i,s,o;s=u.slice(e,t+1||9e9),o=[];for(r=0,i=s.length;r<i;r++)n=s[r],o.push(n.date);return o},s.length=function(){return u.length},s.valueAt=function(e){return u[e]!=null?u[e].num:null},s.dateAt=function(e){return u[e]!=null?u[e].date:null},s.drawPoint=function(e,t,n,r,i){if(this.visible())return e.beginPath(),e.arc(t(r),n(this.valueAt(r)),i,0,Math.PI*2,!0),e.fillStyle=this.color(),e.fill(),e.closePath()},s.drawPath=function(e,t,n,r,i,s){var o,u;if(this.visible()){e.beginPath();for(o=u=r;r<=i?u<=i:u>=i;o=r<=i?++u:--u)e.lineTo(t(o),n(this.valueAt(o)));return e.lineWidth=s,e.strokeStyle=this.color(),e.stroke(),e.closePath()}},s.toggle=function(){var e;return e=!this.visible(),this.visible(e),e},s.id=function(e){return e==null?i:(i=e,s)},s.name=function(e){return e==null?o:(o=e,s)},s.values=function(e){return e==null?u:(u=e,s)},s.visible=function(e){return e==null?f:(f=e,s)},s.color=function(e){return e==null?t:(t=e,s)},s},n.stage=function(){var e,t,n,r,i,s,o,a,h,p,d,v,m,g,y,b,w,E,S=this;return n=this,t=null,o=[],p=Math.floor(n.w()-c-2),s=Math.floor(n.h()*f.h),g=d3.scale.linear(),E=d3.scale.linear(),d=d3.svg.axis().orient("bottom").scale(g),b=d3.svg.axis().orient("left").scale(E),w=null,v=null,i=[],y=0,m=p,h=10,e=null,r=null,a=function(a){var S,x,T,N,C,k,L;o=a.datum(),t==null&&(t="canvas-stage-"+ ++u),a.attr("style","position: absolute; left: 0px; top: 0px;"),w==null&&(w=a.insert("svg"),w.attr("class","y axis"),w.attr("id","y-axis-"+t),w.attr("width",c),w.attr("height",Math.floor(n.h()*f.h)),w.attr("style","position: absolute; left: 0px; top: 0px;")),e=a.append("canvas"),e.attr("width",p),e.attr("height",s),e.attr("class","stage"),e.attr("id",t),e.attr("style","position: absolute; left: "+c+"px; top: 0px;"),r=e.node().getContext("2d"),v==null&&(v=a.append("svg"),v.attr("class","x axis"),v.attr("id","x-axis-"+t),v.attr("width",Math.floor(n.w()-c)),v.attr("height",Math.floor(n.h()*l.h)),v.attr("style","position: absolute; left: "+c+"px; top: "+n.h()*f.h+"px")),b.tickSize(5,3,0),d.tickSize(5,3,0),L=function(){var e;i=n.utility().getExtent(o,y,m),E.domain([i[0],i[1]]),E.range([s-n.padding(),n.padding()]),g.domain([y,m]),g.range([n.padding(),p-n.padding()]),b.tickSize(5,3,0),b.ticks(Math.floor(n.h()*f.h/30)),e=n.utility().getUnitAndDivisor(Math.round(i[1])),b.tickFormat(function(t){var n;return n=(t/e.divisor).toFixed(2),n=n.replace(/0+$/,""),n=n.replace(/\.$/,""),""+n+" "+e.label}),d.ticks(Math.floor((n.w()-c)/100)),d.tickFormat(function(e){var t;if(t=o[0].dateAt(e))return t=new Date(t),""+n.utility().getMonthName(t.getUTCMonth())+" "+t.getUTCDate()+", "+t.getUTCFullYear()})},T=function(){var e,t;w.selectAll("*").remove(),t=w.append("g"),t.attr("transform","translate("+(c-1)+", 0)"),t.call(b),v.selectAll("*").remove(),e=v.append("g"),e.call(d)},N=function(){var e,t,i,o,u,a,l,h,d;l=E.ticks(Math.floor(n.h()*f.h/30));for(i=0,u=l.length;i<u;i++)t=l[i],r.beginPath(),r.strokeStyle="#EDEDED",r.lineWidth=1,r.moveTo(0,Math.floor(E(t))),r.lineTo(p,Math.floor(E(t))),r.stroke(),r.closePath();h=g.ticks(Math.floor((n.w()-c)/100)),d=[];for(o=0,a=h.length;o<a;o++)e=h[o],r.beginPath(),r.strokeStyle="#EDEDED",r.lineWith=1,r.moveTo(g(e),s),r.lineTo(g(e),0),r.stroke(),d.push(r.closePath());return d},x=function(e){var t,n,i,u,a,f,l;T(),r.clearRect(0,0,p,s),N(),e=e!=null?e:-1;for(n=a=0,l=o.length;a<l;n=++a){i=o[n],u=n===e?3:1.5;if(m-y<=h){i.drawPath(r,g,E,y,m,u);for(t=f=y;y<=m?f<=m:f>=m;t=y<=m?++f:--f)i.drawPoint(r,g,E,t,3)}else m===y?i.drawPoint(r,g,E,y,3):i.drawPath(r,g,E,y,m,u)}},k=function(e){var t,i,s,u,a,f,l,c,h,p,d,v,m,g;t=n.utility().getPixelRGB(e,r),s=_.indexOf(n.colorList(),t);if(s!==-1)return{x:e[0],color:t,line:o[s]};i=[];for(u=l=p=e[0]-3,d=e[0]+3;p<=d?l<=d:l>=d;u=p<=d?++l:--l)for(a=c=v=e[1]-3,m=e[1]+3;v<=m?c<=m:c>=m;a=v<=m?++c:--c)(u!==e[0]||a!==e[1])&&i.push([u,a]);for(f=h=0,g=i.length-1;0<=g?h<=g:h>=g;f=0<=g?++h:--h){t=n.utility().getPixelRGB(i[f],r),s=_.indexOf(n.colorList(),t);if(s!==-1)return{x:i[f][0],color:t,line:o[s]}}return!1},C=function(e,t,i,s){var o,u,a,f,l,c;o=new Date(i.dateAt(t)),l=i.valueAt(t),x(i.id()),a=m-y<=h?5:3,i.drawPoint(r,g,E,t,a),u=e[1]<=20&&e[0]>=p-250,c=u?p-400:p,r.beginPath(),r.fillStyle="rgba(237, 237, 237, 0.80)",r.fillRect(c-240,0,240,15),r.closePath(),r.fillStyle="#000",r.textAlign="start",f=""+n.utility().getMonthName(o.getUTCMonth())+"  "+o.getUTCDate()+", "+o.getFullYear()+": ",f+=""+n.utility().formatNumberAsString(l.toFixed(2)),r.fillText(f,c-110,10,100),r.fillStyle=i.color(),r.textAlign="end",r.fillText(""+n.utility().truncate(i.name(),20),c-120,10,200)},S=function(){x()},n.dombrush()==null&&(y=0,m=o[0].length()-1,L(),x()),n.on("respond.stage",function(){r.clearRect(0,0,p,s),p=Math.floor(n.w()-c-1),s=Math.floor(n.h()*f.h),e.attr("width",p),e.attr("height",s),w.attr("width",c),v.attr("width",Math.floor(n.w()-c)),L(),x()}),n.on("adjust.stage",function(e,t){y=e>0?e:0,m=o[0].length()>t?t:o[0].length()-1,L(),x()}),n.on("toggle.stage",function(){L(),x()}),n.on("refresh.stage",function(){o=a.datum(),n.dombrush()||x()}),d3.select("#"+t).on("mousemove",function(e){var t,n;n=d3.mouse(this),t=k(n),t!==!1?C(n,Math.round(g.invert(t.x)),t.line,t.color):S()})},a.canvasId=function(e){return e==null?t:(t=e,a)},a.xScale=function(e){return e==null?g:(g=e,a)},a.yScale=function(e){return e==null?E:(E=e,a)},a.xEnd=function(e){return e==null?m:(m=e,a)},a.xStart=function(e){return e==null?y:(y=e,a)},a.threshold=function(e){return e==null?h:(h=e,a)},a},n.brush=function(){var e,t,n,r,i,s,a,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B=this;return h=this,b=Math.floor(h.h()*o.h),w=b,L=Math.floor(h.w()-c),A=L,n=null,r=null,y=10,D=null,P=null,_=d3.scale.linear(),H=d3.scale.linear(),s=null,p=null,O=d3.svg.axis().orient("bottom").scale(_),M=null,a=null,g=[],E=[],N=10,m=!1,v=!0,T=!1,S=6,x=0,e=0,C=null,d={move:"move",resize:"resize"},i=document.createElement("canvas"),k=!1,t=function(t){var B,j,F,I,q,R,U,z,W,X,V,J,K,Q,G,Y,Z;return E=t.datum(),a==null&&(a="canvas-brush-"+ ++u),t.attr("style","position: absolute; top: "+h.h()*(f.h+l.h)+"px; left: "+c+"px"),s=t.append("canvas"),s.attr("id",a),s.attr("style","position: absolute; left: 0px; top: 0px"),p=s.node().getContext("2d"),M==null&&(M=t.append("svg"),M.attr("class","x axis"),M.attr("id","x-axis-"+a),M.attr("height",Math.floor(h.h()*l.h)),M.attr("width",Math.floor(h.w()-c)),M.attr("style","position: absolute; top: "+h.h()*o.h+"px; left: 0px")),O.tickSize(5,3,0),Y=function(){g=h.utility().getExtent(E,null,null),H.domain([g[0],g[1]]),H.range([b-h.padding(),h.padding()]),_.domain([0,E[0].length()-1]),_.range([h.padding(),L-h.padding()]),x=Math.floor(_(S)),O.ticks(Math.floor((h.w()-c)/100)),O.tickFormat(function(e){var t;return t=new Date(E[0].dateAt(e)),""+h.utility().getMonthName(t.getUTCMonth())+" "+t.getUTCDate()+", "+t.getUTCFullYear()})},G=function(){D=_(h.startPoint()*E[0].length()),P=D,n=L-D,r=n,n<x&&(n=x,r=n,D=L-n,P=D)},Z=function(){F(),k?z():q(),U()},F=function(){p.clearRect(0,0,A,w),s.attr("width",L).attr("height",b)},R=function(){var e;M.selectAll("*").remove(),e=M.append("g"),e.call(O)},q=function(){var e,t,n,r,i;n=E[0].length()<=N;for(e=r=0,i=E.length;r<i;e=++r)t=E[e],t.drawPath(p,_,H,0,E[0].length(),1),n&&t.drawPoint(p,_,H,e,2);Q()},z=function(){p.drawImage(i.canvas,0,0)},Q=function(){k=!0,i.setAttribute("width",L),i.setAttribute("height",b),i=i.getContext("2d"),i.drawImage(document.getElementById(a),0,0)},U=function(){p.strokeStyle="rgba(237, 237, 237, 0.80)",p.beginPath(),p.fillStyle="rgba(237, 237, 237, 0.80)",p.fillRect(D,0,n,b),p.lineWidth=1,p.lineTo(D,b),p.closePath(),p.beginPath(),p.fillStyle="#D9D9D9",p.fillRect(D-y,0,y,b),p.closePath(),p.beginPath(),p.fillStyle="#D9D9D9",p.fillRect(D+n,0,y,b),p.closePath()},j=function(){return E[0].length()-1<=S?(D=0,r=L,n=L,v=!1):v=!0},J=function(){i=document.createElement("canvas"),k=!1},I=function(){var e,t;e=_.invert(D),t=_.invert(D+n),h.adjust(Math.ceil(e),Math.ceil(t))},K=function(){m=!1,T=!1,e=0,P=D,r=n},W=function(e){return e<=n+D&&e>=D},X=function(e){return e>=D-y&&e<D},V=function(e){return e>D+n&&e<=D+n+y},B=function(e){var t,n;t=function(){var e;e=[];for(n in d)e.push(n);return e}().reduce(function(e,t){return""+e+" "+t}),$(h.dombrush()).removeClass(t).addClass(e)},Y(),j(),v&&G(),R(),I(),setInterval(Z,70),h.on("respond.brush",function(){w=b,A=L,b=Math.floor(h.h()*o.h),L=Math.floor(h.w()-c),D=Math.floor(D/A*L),P=Math.floor(P/A*L),n=Math.floor(n/A*L),r=n,M.attr("width",L),J(),Y(),R()}),h.on("refresh.brush",function(){E=t.datum(),J(),Y(),j(),v&&G(),R(),I()}),h.on("toggle.brush",function(){J(),Y()}),s.on("mousedown",function(t){var n;d3.event.preventDefault(),n=d3.mouse(this),C=n[0],X(n[0])?(T=!0,e=-1):V(n[0])?(T=!0,e=1):W(n[0])&&(m=!0)}),s.on("mouseup",function(e){K()}),s.on("mouseout",function(e){K()}),s.on("mousemove",function(t){var i,s;s=d3.mouse(this);if(m||T){i=s[0]-C;if(m&&v)D=P+i;else if(T){if(e!==0&&e!==-1&&e!==1)throw"Error: Unknown stretching direction";n=e===-1?r-i:r+i,e===-1&&(D=P+i),n<=x&&(e===-1&&(D+=n-x),n=x)}I()}else v&&(W(s[0])?B(d.move):X(s[0])||V(s[0])?B(d.resize):B(""))})},t.canvasId=function(e){return e==null?a:(a=e,t)},t.xScale=function(e){return e==null?_:(_=e,t)},t.threshold=function(e){return e==null?N:(N=e,t)},t.stretchLimit=function(e){return e==null?S:(S=e,t)},t.handleWidth=function(e){return e==null?y:(y=e,t)},t.cursorClasses=function(e){return e==null?d:(d=e,t)},t},n.xaxis=function(){var e,t,n,r,i,s,o,u,a,f,c,h=this;return n=this,f=n.w()*l.w,i=n.h()*l.h,a=d3.time.scale().range([0,f]),t=d3.svg.axis().scale(a),r=[],e=!1,o=[],s=null,u=null,c=function(h){var p,d;s=h.attr("id"),o=h.datum(),t.tickSize(5,3,0),d=function(){var e;return c.remove(),e=h.append("svg"),e.attr("width",f),e.attr("height",i),e.append("g"),e.attr("transform","translate(0, 27)"),e.call(t)},p=function(){return r=[o[0].dateAt(0),o[0].dateAt(o[0].length()-1)],u=n.utility().parseDate(o[0].dateAt(0)),a.domain([u(r[0]),u(r[1])]),t.tickFormat(d3.time.format("%b %d, %Y")),t.ticks(Math.floor(f/150,0,0)),a.range([0,f])},p(),d(),n.on("respond.xaxis-"+s,function(){return f=n.w()*l.w,t.ticks(Math.floor(f/150,0,0)),a.range([0,f]),d()}),n.on("refresh.xaxis-"+s,function(){return o=h.datum(),p(),d()}),e&&n.on("adjust.xaxis-"+s,function(e,t){return t=t>o[0].length()-1?o[0].length()-1:t,e=e<0?0:e,r=[o[0].dateAt(e),o[0].dateAt(t)],a.domain([u(r[0]),u(r[1])]),d()})},c.remove=function(){return d3.select("#"+s).selectAll("svg").remove()},c.active=function(t){return t?(e=t,c):e},d3.rebind(c,t,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},n.yaxis=function(){var e,t,n,r,i,s,o,u,a,f,l,c=this;return t=this,u=t.w()*quandlism_yaxis.w,r=t.h()*quandlism_yaxis.h,o=d3.scale.linear().range([r,0]),e=d3.svg.axis().scale(o),s=[],n=[],f=null,a=null,i=null,l=function(c){var h,p;i=c.attr("id"),s=c.datum(),e.ticks(Math.floor(r/25,0,0)),e.tickSize(5,3,0),p=function(){var i,h;return n=t.utility().getExtent(s,f,a),o.domain([n[0],n[1]]),l.remove(),h=c.append("svg"),h.attr("width",u),h.attr("height","100%"),i=h.append("g"),i.attr("transform","translate("+(u-1)+", 0)"),i.attr("width",u),i.attr("height",r),i.call(e)},h=function(){a=s[0].length()-1,f=Math.floor(s[0].length()*t.endPercent())},h(),p(),t.on("toggle.y-axis-"+i,function(){p()}),t.on("refresh.y-axis-"+i,function(){s=c.datum(),h(),p()}),t.on("respond.y-axis-"+i,function(){u=t.w()*quandlism_yaxis.w,r=t.h()*quandlism_yaxis.h,e.ticks(Math.floor(r/25,0,0)),o.range([r,0]),p()}),t.on("adjust.y-axis-"+i+"}",function(e,t){f=e>0?e:0,a=t<s[0].length()?t:s[0].length(),p()})},l.remove=function(e){d3.select("#"+i).selectAll("svg").remove()},d3.rebind(l,e,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},n.legend=function(){var e,t,n;return e=this,n=[],t=function(t){var r=this;n=t.datum(),t.selectAll("li").remove(),t.selectAll("li").data(n).enter().append("li").attr("style",function(e){return"color: "+e.color()}).attr("class",function(e){if(!e.visible())return"off"}).append("a",":first-child").attr("href","javascript:;").attr("data-line-id",function(e){return e.id()}).text(function(e){return e.name()}),t.selectAll("a").on("click",function(t,r){var i,s,o,u;i=d3.event,s=i.target,o=parseInt(s.getAttribute("data-line-id")),i.preventDefault(),u=_.find(n,function(e){return e.id()===o}),u!=null&&(u.toggle()===!1?$(s).parent().addClass("off"):$(s).parent().removeClass("off"),e.toggle())})},t},n.utility=function(){var e,t,n=this;return e=this,t=function(){},t.truncate=function(e,t){return e.length>t?""+e.substring(0,t)+"...":e},t.createLines=function(n){var r,i,s,o,u,a,f,l,c,h;s=n.columns.slice(1),u=_.map(s,function(e,t){return _.map(n.data,function(e){return{date:e[0],num:+e[t+1]}})});if(!e.lines().length){r=t.defaultColumn(n.code),a=_.map(s,function(t,n){return e.line({name:t,values:u[n]})});for(i=f=0,c=a.length;f<c;i=++f)o=a[i],i!==r&&o.visible(!1)}else{a=e.lines();for(i=l=0,h=a.length;l<h;i=++l)o=a[i],o.values(u[i].reverse())}return a},t.defaultColumn=function(e){return e==null?0:e.match(/^FUTURE_/)?3:0},t.getExtent=function(e,t,n){var r,i;return r=function(){var r,s,o;o=[];for(r=0,s=e.length;r<s;r++)i=e[r],o.push(i.extent(t,n));return o}(),[d3.min(r,function(e){return e[0]}),d3.max(r,function(e){return e[1]})]},t.getMonthName=function(e){var t;return t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],t[e]},t.getColor=function(t){return e.colorList()[t]},t.formatNumberAsString=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},t.getPixelRGB=function(e,t){var n,r;return n=t.getImageData(e[0],e[1],1,1).data,r=d3.rgb(n[0],n[1],n[2]),r.toString()},t.getUnitAndDivisor=function(e){var t;return t=e.toString().length,t<=3?{label:"",divisor:1}:t<=6?{label:"K",divisor:1e3}:t<=9?{label:"M",divisor:1e6}:{label:"B",divisor:1e9}},t.dateFormat=function(e){var t,n;n=e.split("-").length-1;switch(n){case-1:t="%Y";break;case 2:t="%Y-%m-%d";break;default:throw"Unknown date format: "+n+" "+e}return t},t.parseDate=function(e){var t;return t=this.dateFormat(e),d3.time.format(t).parse},t}}).call(this)})(this);