(function(e){(function(){var t,n,r,i,s,o,u,a,f,l,c;i=e.quandlism={version:"0.4.0"},i.context=function(){var e,n,r,i,s,o,u,a,f,l,c,h,p,d=this;return n=new t,p=null,f=null,r=null,o=null,i=null,s=null,u=null,c=0,h=.75,a=d3.dispatch("respond","adjust","toggle","refresh"),e=["#e88033","#4eb15d","#c45199","#6698cb","#6c904c","#e9563b","#9b506f","#d2c761","#4166b0","#44b1ae"],l=[],n.attachData=function(t){var r,u,a,f;if(!l.length){n.addColorsIfNecessary(t);for(r=a=0,f=t.length;a<f;r=++a)u=t[r],u.color(e[r])}return l=t,o&&d3.select(o).datum(l),i&&d3.select(i).datum(l),s&&d3.select(s).datum(l),n},n.render=function(){return o&&d3.select(o).call(n.stage()),i&&d3.select(i).call(n.brush()),s&&d3.select(s).call(n.legend()),n},n.build=function(){return p=$(r).width(),f=$(r).height(),n},n.addColorsIfNecessary=function(t){var n,r,i,s;r=t.length-e.length;if(r<0)return;n=.3,i=0;while(i<r)s=d3.rgb(e[i]).brighter(n),e.push(s.toString()),i++},n.lines=function(e){return e?(l=e,n):l},n.colorList=function(t){return t==null?e:(e=t,n)},n.startPoint=function(e){return e==null?h:(h=e,n)},n.w=function(e){return e==null?p:(p=e,n)},n.h=function(e){return e==null?f:(f=e,n)},n.dom=function(e){return e==null?r:(r=e,n)},n.domstage=function(e){return e==null?o:(o=e,n)},n.dombrush=function(e){return e==null?i:(i=e,n)},n.domlegend=function(e){return e==null?s:(s=e,n)},n.padding=function(e){return e==null?c:(c=e,n)},n.respond=_.throttle(function(){return a.respond.call(n,500)}),n.adjust=function(e,t){return a.adjust.call(n,e,t)},n.toggle=function(){return a.toggle.call(n)},n.refresh=function(){return a.refresh.call(n)},n.on=function(e,t){return t==null?a.on(e):(a.on(e,t),n)},d3.select(window).on("resize",function(){var e,t;d3.event.preventDefault();if(r){t=$(r).width(),e=$(r).height();if(p!==t||f!==e)p=t,f=e,n.respond()}}),n},t=function(){function e(){}return e}(),n=t.prototype=i.context.prototype,s=0,a=0,u=0,c=40,l={h:.1},o={h:.15},f={h:.65},r=function(){function e(){}return e}(),n.line=function(e){var t,n,i,s,o,u,f,l=this;return s=new r,n=this,o=e.name,u=e.values.reverse(),i=a++,f=!0,t="#000000",s.extent=function(e,t){var n,r,i,s,o;n=e!=null?e:0,s=t!=null?t:this.length()-1,i=Infinity,r=-Infinity;if(!this.visible())return[i,r];while(n<=s){o=this.valueAt(n);if(o==null){n++;continue}o<i&&(i=o),o>r&&(r=o),n++}return[i,r]},s.dates=function(e,t){var n,r,i,s,o;s=u.slice(e,t+1||9e9),o=[];for(r=0,i=s.length;r<i;r++)n=s[r],o.push(n.date);return o},s.length=function(){return u.length},s.valueAt=function(e){return u[e]!=null?u[e].num:null},s.dateAt=function(e){return u[e]!=null?u[e].date:null},s.drawPoint=function(e,t,n,r,i){if(this.visible())return e.beginPath(),e.arc(t(r),n(this.valueAt(r)),i,0,Math.PI*2,!0),e.fillStyle=this.color(),e.fill(),e.closePath()},s.drawPath=function(e,t,n,r,i,s){var o,u;if(this.visible()){e.beginPath();for(o=u=r;r<=i?u<=i:u>=i;o=r<=i?++u:--u)e.lineTo(t(o),n(this.valueAt(o)));return e.lineWidth=s,e.strokeStyle=this.color(),e.stroke(),e.closePath()}},s.toggle=function(){var e;return e=!this.visible(),this.visible(e),e},s.id=function(e){return e==null?i:(i=e,s)},s.name=function(e){return e==null?o:(o=e,s)},s.values=function(e){return e==null?u:(u=e,s)},s.visible=function(e){return e==null?f:(f=e,s)},s.color=function(e){return e==null?t:(t=e,s)},s},n.stage=function(){var e,t,n,r,i,s,o,a,h,p,d,v,m,g,y,b,w,E,S=this;return n=this,t=null,o=[],p=Math.floor(n.w()-c-1),s=Math.floor(n.h()*f.h),g=d3.scale.linear(),E=d3.scale.linear(),d=d3.svg.axis().orient("bottom").scale(g),b=d3.svg.axis().orient("left").scale(E),w=null,v=null,i=[],y=0,m=p,h=10,e=null,r=null,a=function(a){var S,x,T,N,C,k,L;o=a.datum(),t==null&&(t="canvas-stage-"+ ++u),w==null&&(w=a.insert("svg"),w.attr("class","y axis"),w.attr("id","y-axis-"+t),w.attr("width",c),w.attr("height",Math.floor(n.h()*f.h))),e=a.append("canvas"),e.attr("width",p),e.attr("height",s),e.attr("class","stage"),e.attr("id",t),r=e.node().getContext("2d"),v==null&&(v=a.append("svg"),v.attr("class","x axis"),v.attr("id","x-axis-"+t),v.attr("width",Math.floor(n.w()-c)),v.attr("height",Math.floor(n.h()*l.h)),v.attr("style","margin-left: "+c)),b.tickSize(5,3,0),d.tickSize(5,3,0),L=function(){var e,t;i=n.utility().getExtent(o,y,m),E.domain([i[0],i[1]]),E.range([s-n.padding(),n.padding()]),g.domain([y,m]),g.range([n.padding(),p-n.padding()]),b.tickSize(5,3,0),b.ticks(Math.floor(n.h()*f.h/30)),t=n.utility().getUnit(Math.round(i[1])),e=1,t==="K"&&(e=1e3),t==="M"&&(e=1e6),b.tickFormat(function(n){var r;return r=(n/e).toFixed(2),r=r.replace(/0+$/,""),r=r.replace(/\.$/,""),""+r+" "+t}),d.ticks(Math.floor((n.w()-c)/100)),d.tickFormat(function(e){var t;if(t=o[0].dateAt(e))return t=new Date(t),""+n.utility().getMonthName(t.getUTCMonth())+" "+t.getUTCDate()+", "+t.getUTCFullYear()})},T=function(){var e,t;w.selectAll("*").remove(),t=w.append("g"),t.attr("transform","translate("+(c-1)+", 0)"),t.call(b),v.selectAll("*").remove(),e=v.append("g"),e.call(d)},N=function(){var e,t,i,o,u,a,l,h,d;l=E.ticks(Math.floor(n.h()*f.h/30));for(i=0,u=l.length;i<u;i++)t=l[i],r.beginPath(),r.strokeStyle="#EDEDED",r.lineWidth=1,r.moveTo(0,Math.floor(E(t))),r.lineTo(p,Math.floor(E(t))),r.stroke(),r.closePath();h=g.ticks(Math.floor((n.w()-c)/100)),d=[];for(o=0,a=h.length;o<a;o++)e=h[o],r.beginPath(),r.strokeStyle="#EDEDED",r.lineWith=1,r.moveTo(g(e),s),r.lineTo(g(e),0),r.stroke(),d.push(r.closePath());return d},x=function(e){var t,n,i,u,a,f,l;T(),r.clearRect(0,0,p,s),N(),e=e!=null?e:-1;for(n=a=0,l=o.length;a<l;n=++a){i=o[n],u=n===e?3:1.5;if(m-y<=h){i.drawPath(r,g,E,y,m,u);for(t=f=y;y<=m?f<=m:f>=m;t=y<=m?++f:--f)i.drawPoint(r,g,E,t,3)}else m===y?i.drawPoint(r,g,E,y,3):i.drawPath(r,g,E,y,m,u)}},k=function(e){var t,i,s,u,a,f,l,c,h,p,d,v,m,g;t=n.utility().getPixelRGB(e,r),s=_.indexOf(n.colorList(),t);if(s!==-1)return{x:e[0],color:t,line:o[s]};i=[];for(u=l=p=e[0]-3,d=e[0]+3;p<=d?l<=d:l>=d;u=p<=d?++l:--l)for(a=c=v=e[1]-3,m=e[1]+3;v<=m?c<=m:c>=m;a=v<=m?++c:--c)(u!==e[0]||a!==e[1])&&i.push([u,a]);for(f=h=0,g=i.length-1;0<=g?h<=g:h>=g;f=0<=g?++h:--h){t=n.utility().getPixelRGB(i[f],r),s=_.indexOf(n.colorList(),t);if(s!==-1)return{x:i[f][0],color:t,line:o[s]}}return!1},C=function(e,t,i,s){var o,u,a,f,l;o=new Date(i.dateAt(t)),f=i.valueAt(t),x(i.id()),a=m-y<=h?5:3,i.drawPoint(r,g,E,t,a),u=e[1]<=20&&e[0]>=p-250,l=u?p-400:p,r.beginPath(),r.fillStyle="rgba(237, 237, 237, 0.80)",r.fillRect(l-240,0,240,15),r.closePath(),r.fillStyle="#000",r.textAlign="start",r.fillText(""+n.utility().getMonthName(o.getUTCMonth())+" "+o.getUTCDate()+": "+f.toFixed(2),l-100,10,100),r.fillStyle=i.color(),r.textAlign="end",r.fillText(""+n.utility().truncate(i.name(),20),l-110,10,200)},S=function(){x()},n.dombrush()||L()&&x(),n.on("respond.stage",function(){r.clearRect(0,0,p,s),p=Math.floor(n.w()-c-1),s=Math.floor(n.h()*f.h),e.attr("width",p),e.attr("height",s),w.attr("width",c),v.attr("width",Math.floor(n.w()-c)),v.attr("style","margin-left: "+c),L(),x()}),n.on("adjust.stage",function(e,t){y=e>0?e:0,m=o[0].length()>t?t:o[0].length()-1,L(),x()}),n.on("toggle.stage",function(){L(),x()}),n.on("refresh.stage",function(){o=a.datum(),n.dombrush()||x()}),d3.select("#"+t).on("mousemove",function(e){var t,n;n=d3.mouse(this),t=k(n),t!==!1?C(n,Math.round(g.invert(t.x)),t.line,t.color):S()})},a.canvasId=function(e){return e==null?t:(t=e,a)},a.xScale=function(e){return e==null?g:(g=e,a)},a.yScale=function(e){return e==null?E:(E=e,a)},a.xEnd=function(e){return e==null?m:(m=e,a)},a.xStart=function(e){return e==null?y:(y=e,a)},a.threshold=function(e){return e==null?h:(h=e,a)},a},n.brush=function(){var e,t,n,r,i,s,a,f,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D=this;return a=this,g=Math.floor(a.h()*o.h),y=g,N=Math.floor(a.w()-c),C=N,n=null,r=null,m=10,O=null,M=null,A=d3.scale.linear(),_=d3.scale.linear(),i=null,f=null,k=d3.svg.axis().orient("bottom").scale(A),L=null,s=null,v=[],b=[],x=10,d=!1,p=!0,S=!1,w=6,E=0,e=0,T=null,h={move:"move",resize:"resize"},t=function(t){var D,P,H,B,j,F,I,q,R,U,z,W,X,V;return b=t.datum(),s==null&&(s="canvas-brush-"+ ++u),i=t.append("canvas").attr("id",s),f=i.node().getContext("2d"),L==null&&(L=t.append("svg"),L.attr("class","x axis"),L.attr("id","x-axis-"+s),L.attr("height",Math.floor(a.h()*l.h)),L.attr("width",Math.floor(a.w()-c))),k.tickSize(5,3,0),$(""+a.dombrush()).css("marginLeft",""+c+"px"),X=function(){v=a.utility().getExtent(b,null,null),_.domain([v[0],v[1]]),_.range([g-a.padding(),a.padding()]),A.domain([0,b[0].length()-1]),A.range([a.padding(),N-a.padding()]),E=Math.floor(A(w)),k.ticks(Math.floor((a.w()-c)/100)),k.tickFormat(function(e){var t;return t=new Date(b[0].dateAt(e)),""+a.utility().getMonthName(t.getUTCMonth())+" "+t.getUTCDate()+", "+t.getUTCFullYear()})},W=function(){O=A(a.startPoint()*b[0].length()),M=O,n=N-O,r=n,n<E&&(n=E,r=n,O=N-n,M=O)},V=function(){H(),j(),I()},H=function(){f.clearRect(0,0,C,y),i.attr("width",N).attr("height",g)},F=function(){var e;L.selectAll("*").remove(),e=L.append("g"),e.call(k)},j=function(){var e,t,n,r,i;n=b[0].length()<=x;for(e=r=0,i=b.length;r<i;e=++r)t=b[e],t.drawPath(f,A,_,0,b[0].length(),1),n&&t.drawPoint(f,A,_,e,2)},I=function(){f.strokeStyle="rgba(237, 237, 237, 0.80)",f.beginPath(),f.fillStyle="rgba(237, 237, 237, 0.80)",f.fillRect(O,0,n,g),f.lineWidth=1,f.lineTo(O,g),f.closePath(),f.beginPath(),f.fillStyle="#D9D9D9",f.fillRect(O-m,0,m,g),f.closePath(),f.beginPath(),f.fillStyle="#D9D9D9",f.fillRect(O+n,0,m,g),f.closePath()},P=function(){return b[0].length()-1<=w?(O=0,r=N,n=N,p=!1):p=!0},B=function(){var e,t;e=A.invert(O),t=A.invert(O+n),a.adjust(Math.ceil(e),Math.ceil(t))},z=function(){d=!1,S=!1,e=0,M=O,r=n},q=function(e){return e<=n+O&&e>=O},R=function(e){return e>=O-m&&e<O},U=function(e){return e>O+n&&e<=O+n+m},D=function(e){var t,n;t=function(){var e;e=[];for(n in h)e.push(n);return e}().reduce(function(e,t){return""+e+" "+t}),$(a.dombrush()).removeClass(t).addClass(e)},X(),P(),p&&W(),F(),B(),setInterval(V,50),a.on("respond.brush",function(){y=g,C=N,g=Math.floor(a.h()*o.h),N=Math.floor(a.w()-c),O=Math.floor(O/C*N),M=Math.floor(M/C*N),n=Math.floor(n/C*N),r=n,L.attr("width",N),$(""+a.dombrush()).css("marginLeft",""+c+"px"),X(),F()}),a.on("refresh.brush",function(){b=t.datum(),X(),P(),p&&W(),F(),B()}),a.on("toggle.brush",function(){X()}),i.on("mousedown",function(t){var n;d3.event.preventDefault(),n=d3.mouse(this),T=n[0],R(n[0])?(S=!0,e=-1):U(n[0])?(S=!0,e=1):q(n[0])&&(d=!0)}),i.on("mouseup",function(e){z()}),i.on("mouseout",function(e){z()}),i.on("mousemove",function(t){var i,s;s=d3.mouse(this);if(d||S){i=s[0]-T;if(d&&p)O=M+i;else if(S){if(e!==0&&e!==-1&&e!==1)throw"Error: Unknown stretching direction";n=e===-1?r-i:r+i,e===-1&&(O=M+i),n<=E&&(e===-1&&(O+=n-E),n=E)}B()}else q(s[0])?D(h.move):R(s[0])||U(s[0])?D(h.resize):D("")})},t.canvasId=function(e){return e==null?s:(s=e,t)},t.xScale=function(e){return e==null?A:(A=e,t)},t.threshold=function(e){return e==null?x:(x=e,t)},t.stretchLimit=function(e){return e==null?w:(w=e,t)},t.handleWidth=function(e){return e==null?m:(m=e,t)},t.cursorClasses=function(e){return e==null?h:(h=e,t)},t},n.xaxis=function(){var e,t,n,r,i,s,o,u,a,f,c,h=this;return n=this,f=n.w()*l.w,i=n.h()*l.h,a=d3.time.scale().range([0,f]),t=d3.svg.axis().scale(a),r=[],e=!1,o=[],s=null,u=null,c=function(h){var p,d;s=h.attr("id"),o=h.datum(),t.tickSize(5,3,0),d=function(){var e;return c.remove(),e=h.append("svg"),e.attr("width",f),e.attr("height",i),e.append("g"),e.attr("transform","translate(0, 27)"),e.call(t)},p=function(){return r=[o[0].dateAt(0),o[0].dateAt(o[0].length()-1)],u=n.utility().parseDate(o[0].dateAt(0)),a.domain([u(r[0]),u(r[1])]),t.tickFormat(d3.time.format("%b %d, %Y")),t.ticks(Math.floor(f/150,0,0)),a.range([0,f])},p(),d(),n.on("respond.xaxis-"+s,function(){return f=n.w()*l.w,t.ticks(Math.floor(f/150,0,0)),a.range([0,f]),d()}),n.on("refresh.xaxis-"+s,function(){return o=h.datum(),p(),d()}),e&&n.on("adjust.xaxis-"+s,function(e,t){return t=t>o[0].length()-1?o[0].length()-1:t,e=e<0?0:e,r=[o[0].dateAt(e),o[0].dateAt(t)],a.domain([u(r[0]),u(r[1])]),d()})},c.remove=function(){return d3.select("#"+s).selectAll("svg").remove()},c.active=function(t){return t?(e=t,c):e},d3.rebind(c,t,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},n.yaxis=function(){var e,t,n,r,i,s,o,u,a,f,l,c=this;return t=this,u=t.w()*quandlism_yaxis.w,r=t.h()*quandlism_yaxis.h,o=d3.scale.linear().range([r,0]),e=d3.svg.axis().scale(o),s=[],n=[],f=null,a=null,i=null,l=function(c){var h,p;i=c.attr("id"),s=c.datum(),e.ticks(Math.floor(r/25,0,0)),e.tickSize(5,3,0),p=function(){var i,h;return n=t.utility().getExtent(s,f,a),o.domain([n[0],n[1]]),l.remove(),h=c.append("svg"),h.attr("width",u),h.attr("height","100%"),i=h.append("g"),i.attr("transform","translate("+(u-1)+", 0)"),i.attr("width",u),i.attr("height",r),i.call(e)},h=function(){a=s[0].length()-1,f=Math.floor(s[0].length()*t.endPercent())},h(),p(),t.on("toggle.y-axis-"+i,function(){p()}),t.on("refresh.y-axis-"+i,function(){s=c.datum(),h(),p()}),t.on("respond.y-axis-"+i,function(){u=t.w()*quandlism_yaxis.w,r=t.h()*quandlism_yaxis.h,e.ticks(Math.floor(r/25,0,0)),o.range([r,0]),p()}),t.on("adjust.y-axis-"+i+"}",function(e,t){f=e>0?e:0,a=t<s[0].length()?t:s[0].length(),p()})},l.remove=function(e){d3.select("#"+i).selectAll("svg").remove()},d3.rebind(l,e,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},n.legend=function(){var e,t,n;return e=this,n=[],t=function(r){var i=this;return n=r.datum(),r.selectAll("li").remove(),r.selectAll("li").data(n).enter().append("li").attr("style",function(e){return"color: "+e.color()}).append("a",":first-child").attr("href","javascript:;").attr("data-line-id",function(e){return e.id()}).text(function(e){return e.name()}),r.selectAll("a").on("click",function(t,r){var i,s,o;i=d3.event,s=i.target,o=s.getAttribute("data-line-id"),i.preventDefault(),n[o]!=null&&(n[o].toggle()===!1?$(s).parent().addClass("off"):$(s).parent().removeClass("off"),e.toggle())}),t}},n.utility=function(){var e,t,n=this;return e=this,t=function(){},t.truncate=function(e,t){return e.length>t?""+e.substring(0,t)+"...":e},t.createLines=function(t){var n,r,i,s,o,u,a;r=t.columns.slice(1),s=_.map(r,function(e,n){return _.map(t.data,function(e){return{date:e[0],num:+e[n+1]}})});if(!e.lines().length)o=_.map(r,function(t,n){return e.line({name:t,values:s[n]})});else{o=e.lines();for(n=u=0,a=o.length;u<a;n=++u)i=o[n],i.values(s[n].reverse())}return o},t.getExtent=function(e,t,n){var r,i;return r=function(){var r,s,o;o=[];for(r=0,s=e.length;r<s;r++)i=e[r],o.push(i.extent(t,n));return o}(),[d3.min(r,function(e){return e[0]}),d3.max(r,function(e){return e[1]})]},t.getMonthName=function(e){var t;return t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],t[e]},t.getColor=function(t){return e.colorList()[t]},t.formatNumberAsString=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},t.getPixelRGB=function(e,t){var n,r;return n=t.getImageData(e[0],e[1],1,1).data,r=d3.rgb(n[0],n[1],n[2]),r.toString()},t.getUnit=function(e){var t;return t=e.toString().length,t<=3?"":t<=6?"K":"M"},t.dateFormat=function(e){var t,n;n=e.split("-").length-1;switch(n){case-1:t="%Y";break;case 2:t="%Y-%m-%d";break;default:throw"Unknown date format: "+n+" "+e}return t},t.parseDate=function(e){var t;return t=this.dateFormat(e),d3.time.format(t).parse},t}}).call(this)})(this);