(function(e){(function(){var t,n,r,i,s,o,u,a,f,l,c;i=e.quandlism={version:"0.2.0"},i.context=function(){var e=this;return this.context=new t,this.w=null,this.h=null,this.dom=null,this.domstage=null,this.dombrush=null,this.domlegend=null,this.domtooltip=null,this.endPercent=.8,this.event=d3.dispatch("respond","adjust","toggle","refresh"),this.colorScale=d3.scale.category20(),this.lines=[],this.context.attachData=function(t){var n,r;return e.lines=t,e.domstage&&(r=d3.select(e.domstage).datum(t)),r&&r.select(".x")&&r.select(".x").datum(t),r&&r.select(".y")&&r.select(".y").datum(t),e.dombrush&&(n=d3.select(e.dombrush).datum(t)),n&&n.select(".x")&&n.select(".x").datum(t),e.domlegend&&d3.select(e.domlegend).datum(t),e.context},this.context.render=function(){return e.domstage&&d3.select(e.domstage).call(e.context.stage()),e.dombrush&&d3.select(e.dombrush).call(e.context.brush()),e.domlegend&&d3.select(e.domlegend).call(e.context.legend()),e.context},this.context.build=function(){return e.w=$(e.dom).width(),e.h=$(e.dom).height(),e.context},this.context.lines=function(t){return t==null?e.lines:(e.lines=t,e.context)},this.context.colorScale=function(t){return t==null?e.colorScale:(e.colorScale=t,e.context)},this.context.endPercent=function(t){return t==null?e.endPercent:(e.endPercent=t,e.context)},this.context.w=function(t){return t==null?e.w:(e.w=t,e.context)},this.context.h=function(t){return t==null?e.h:(e.h=t,e.context)},this.context.dom=function(t){return t==null?e.dom:(e.dom=t,e.context)},this.context.domstage=function(t){return t==null?e.domstage:(e.domstage=t,e.context)},this.context.dombrush=function(t){return t==null?e.dombrush:(e.dombrush=t,e.context)},this.context.domlegend=function(t){return t==null?e.domlegend:(e.domlegend=t,e.context)},this.context.domtooltip=function(t){return t==null?e.domtooltip:(e.domtooltip=t,e.context)},this.context.respond=_.throttle(function(){return e.event.respond.call(e.context,500)}),this.context.adjust=function(t,n){return e.event.adjust.call(e.context,t,n)},this.context.toggle=function(){return e.event.toggle.call(e.context)},this.context.refresh=function(){return e.event.refresh.call(e.context)},this.context.on=function(t,n){return n==null?e.event.on(t):(e.event.on(t,n),e.context)},d3.select(window).on("resize",function(){var t,n;d3.event.preventDefault();if(e.dom){n=$(e.dom).width(),t=$(e.dom).height();if(e.w!==n||e.h!==t)e.w=n,e.h=t,e.context.respond()}}),this.context},t=function(){function e(){}return e}(),n=t.prototype=i.context.prototype,s=0,a=0,u=0,f={w:.84,h:.6},o={w:.84,h:.1},l={w:.84,h:.15},c={w:.15,h:.6},r=function(){function e(){}return e}(),n.line=function(e){var t,n,i,s,o,u,f=this;return i=new r(t),t=this,s=e.name,o=e.values.reverse(),n=a++,u=!0,i.extent=function(e,t){var n,r,i,s,o;n=e!=null?e:0,s=t!=null?t:this.length()-1,i=Infinity,r=-Infinity;if(!this.visible())return[i,r];while(n<=s){o=this.valueAt(n);if(o==null){n++;continue}o<i&&(i=o),o>r&&(r=o),n++}return[i,r]},i.length=function(){return o.length},i.valueAt=function(e){return o[e]!=null?o[e].num:null},i.dateAt=function(e){return o[e]!=null?o[e].date:null},i.drawPoint=function(e,t,n,r,i,s){if(this.visible())return t.beginPath(),t.arc(n(i),r(this.valueAt(i)),s,0,Math.PI*2,!0),t.fillStyle=e,t.fill(),t.closePath()},i.drawPath=function(e,t,n,r,i,s,o){var u,a;if(this.visible()){t.beginPath();for(u=a=i;i<=s?a<=s:a>=s;u=i<=s?++a:--a)t.lineTo(n(u),r(this.valueAt(u)));return t.lineWidth=o,t.strokeStyle=e,t.stroke(),t.closePath()}},i.toggle=function(){var e;return e=!this.visible(),this.visible(e),e},i.id=function(e){return e==null?n:(n=e,i)},i.name=function(e){return e==null?s:(s=e,i)},i.values=function(e){return e==null?o:(o=e,i)},i.visible=function(e){return e==null?u:(u=e,i)},i},n.stage=function(){var e,t,n,r,i,s,o,a,h,p,d,v,m,g,y,b,w,E=this;return n=this,t=null,o=[],d=Math.floor(n.w()*f.w),s=Math.floor(n.h()*f.h),g=d3.scale.linear(),w=d3.scale.linear(),v=null,b=null,a=10,i=[],y=null,m=null,p=10,e=null,r=null,h=function(h){var E,S,x,T;o=h.datum(),t="canvas-stage-"+ ++u,b==null&&(b=h.append("div"),b.datum(o),b.attr("height",n.h()*c.h),b.attr("width",n.w()*c.w),b.attr("class","axis y"),b.attr("id","y-axis-"+t),b.call(n.yaxis().orient("left"))),e=h.append("canvas"),e.attr("width",d),e.attr("height",s),e.attr("class","stage"),e.attr("id",t),r=e.node().getContext("2d"),v==null&&(v=h.append("div"),v.datum(o),v.attr("width",n.w()*l.w),v.attr("height",n.h()*l.h),v.attr("class","x axis"),v.attr("id","x-axis-"+t),v.call(n.xaxis().active(!0))),y=y?y:Math.floor(o[0].length()*n.endPercent()),m=m?m:o[0].length(),S=function(e){var t,u,f,l,c,h,v;i=n.utility().getExtent(o,y,m),w.domain([i[0],i[1]]),w.range([s-a,a]),g.domain([y,m]),g.range([a,d-a]),r.clearRect(0,0,d,s),e=e!=null?e:-1,v=[];for(u=c=0,h=o.length;c<h;u=++c)f=o[u],l=u===e?3:1.5,m-y<=p?(f.drawPath(n.utility().getColor(u),r,g,w,y,m,l),v.push(function(){var e,i;i=[];for(t=e=y;y<=m?e<=m:e>=m;t=y<=m?++e:--e)i.push(f.drawPoint(n.utility().getColor(u),r,g,w,t,3));return i}())):m===y?v.push(f.drawPoint(n.utility().getColor(u),r,g,w,y,3)):v.push(f.drawPath(n.utility().getColor(u),r,g,w,y,m,l));return v},T=function(e){var t,i,s,u,a,f,l,c,h,p,d,v,m,g;t=n.utility().getPixelRGB(e,r),s=_.indexOf(n.colorScale().range(),t);if(s!==-1)return{x:e[0],color:t,line:o[s]};i=[];for(u=l=p=e[0]-3,d=e[0]+3;p<=d?l<=d:l>=d;u=p<=d?++l:--l)for(a=c=v=e[1]-3,m=e[1]+3;v<=m?c<=m:c>=m;a=v<=m?++c:--c)(u!==e[0]||a!==e[1])&&i.push([u,a]);for(f=h=0,g=i.length-1;0<=g?h<=g:h>=g;f=0<=g?++h:--h){t=n.utility().getPixelRGB(i[f],r),s=_.indexOf(n.colorScale().range(),t);if(s!==-1)return{x:i[f][0],color:t,line:o[s]}}return!1},x=function(e,t,i){var s;$(n.domtooltip()).html("<span style='color: "+i+";'>"+t.name()+"</span>: "+t.valueAt(e)),S(t.id()),s=m-y<=p?5:3,t.drawPoint(i,r,g,w,e,s)},E=function(){$(n.domtooltip()).text(""),S()},S(),n.on("respond.stage",function(){r.clearRect(0,0,d,s),d=Math.floor(n.w()*f.w),s=Math.floor(n.h()*f.h),e.attr("width",d),e.attr("height",s),S()}),n.on("adjust.stage",function(e,t){y=e>0?e:0,m=o[0].length()>2?t:o[0].length()-1,S()}),n.on("toggle.stage",function(){S()}),n.on("refresh.stage",function(){o=h.datum(),m=o[0].length(),y=Math.floor(o[0].length()*n.endPercent()),S()}),n.domtooltip()!=null&&d3.select("#"+t).on("mousemove",function(e){var t;return t=T(d3.mouse(this)),t!==!1?x(Math.round(g.invert(t.x)),t.line,t.color):E()})},h.padding=function(e){return e==null?a:(a=e,h)},h.canvasId=function(e){return e==null?t:(t=e,h)},h.width=function(e){return e==null?d:(d=e,h)},h.height=function(e){return e==null?s:(s=e,h)},h.xScale=function(e){return e==null?g:(g=e,h)},h.yScale=function(e){return e==null?w:(w=e,h)},h.xEnd=function(e){return e==null?m:(m=e,h)},h.xStart=function(e){return e==null?y:(y=e,h)},h.threshold=function(e){return e==null?p:(p=e,h)},h},n.brush=function(){var e,t,n,r,i,s,a,f,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L=this;return a=this,d=a.h()*o.h,v=d,E=a.w()*o.w,S=E,n=Math.ceil(E*.2),r=n,p=10,N=E*a.endPercent(),C=N,T=d3.scale.linear(),k=d3.scale.linear(),i=null,f=null,x=null,s=null,h=[],g=[],b=10,c=!1,y=!1,e=0,w=null,m=null,t=function(t){var L,A,O,M,_,D,P;return g=t.datum(),s="canvas-brush-"+ ++u,i=t.append("canvas").attr("width",E).attr("height",d).attr("class","brush").attr("id",s),f=i.node().getContext("2d"),x==null&&(x=t.append("div"),x.datum(g),x.attr("class","x axis"),x.attr("width",a.w()*l.w),x.attr("height",a.h()*l.h),x.attr("id","x-axis-"+s),x.call(a.xaxis())),D=function(){return h=a.utility().getExtent(g,null,null),k.domain([h[0],h[1]]),k.range([d,0]),T.domain([0,g[0].length()-1]),T.range([0,E])},P=function(){return L(),O(),M()},L=function(){return f.clearRect(0,0,S,v),i.attr("width",E).attr("height",d)},O=function(){var e,t,n,r,i,s;n=g[0].length()<=b,s=[];for(e=r=0,i=g.length;r<i;e=++r)t=g[e],t.drawPath(a.utility().getColor(e),f,T,k,0,g[0].length(),1),n?s.push(t.drawPoint(a.utility().getColor(e),f,T,k,e,2)):s.push(void 0);return s},M=function(){return f.strokeStyle="rgba(207, 207, 207, 0.55)",f.beginPath(),f.fillStyle="rgba(207, 207, 207, 0.55)",f.fillRect(N,0,n,d),f.lineWidth=1,f.lineTo(N,d),f.closePath(),f.beginPath(),f.lineWidth=p,f.strokeStyle="#CFCFCF",f.moveTo(N,0),f.lineTo(N,d),f.stroke(),f.closePath(),f.beginPath(),f.lineWidth=p,f.strokeStyle="#CFCFCF",f.moveTo(N+n,0),f.lineTo(N+n,d),f.stroke(),f.closePath()},A=function(){var e,t;return e=T.invert(N),t=T.invert(N+n),a.adjust(Math.ceil(e),Math.ceil(t))},_=function(){return c=!1,y=!1,e=0,C=N,r=n},D(),A(),setInterval(P,50),a.on("respond.brush",function(){return v=d,S=E,d=a.h()*o.h,E=a.w()*o.w,N=Math.ceil(N/S*E),C=Math.ceil(C/S*E),D()}),a.on("refresh.brush",function(){return g=t.datum(),N=Math.ceil(E*a.endPercent()),C=N,n=Math.ceil(E*.2),r=n,D()}),a.on("toggle.brush",function(){return D()}),i.on("mousedown",function(t){var r;r=d3.mouse(this),w=r[0];if(r[0]>=N&&r[0]<=N+p)return y=!0,e=-1;if(r[0]>=N+n&&r[0]<=N+n+p)return y=!0,e=1;if(r[0]<=n+N&&r[0]>=N)return c=!0}),i.on("mouseup",function(e){_()}),i.on("mousemove",function(t){var i,s;s=d3.mouse(this);if(c||y){if(m!=null&&Math.abs(m-s[0])>=100){_();return}if(c)N=C+(s[0]-w);else if(y){i=s[0]-w;if(e===-1)N=C+i,n=r-i;else{if(e!==1)throw"Error: Unknown stretchign direction";n=r+i}}A()}m=s[0]})},t.xAxis=function(e){return e==null?x:(x=e,t)},t.threshold=function(e){return e==null?b:(b=e,t)},t},n.xaxis=function(){var e,t,n,r,i,s,o,u,a,f,c,h=this;return n=this,f=n.w()*l.w,i=n.h()*l.h,a=d3.time.scale().range([0,f]),t=d3.svg.axis().scale(a),r=[],e=!1,o=[],s=null,u=null,c=function(h){var p,d;s=h.attr("id"),o=h.datum(),t.tickSize(5,3,0),d=function(){var e;return c.remove(),e=h.append("svg"),e.attr("width",f),e.attr("height",i),e.append("g"),e.attr("transform","translate(0, 27)"),e.call(t)},p=function(){return r=[o[0].dateAt(0),o[0].dateAt(o[0].length()-1)],u=n.utility().parseDate(o[0].dateAt(0)),a.domain([u(r[0]),u(r[1])]),t.tickFormat(d3.time.format("%b %d, %Y")),t.ticks(Math.floor(f/150,0,0)),a.range([0,f])},p(),d(),n.on("respond.xaxis-"+s,function(){return f=n.w()*l.w,t.ticks(Math.floor(f/150,0,0)),a.range([0,f]),d()}),n.on("refresh.xaxis-"+s,function(){return o=h.datum(),p(),d()}),e&&n.on("adjust.xaxis-"+s,function(e,t){return t=t>o[0].length()-1?o[0].length()-1:t,e=e<0?0:e,r=[o[0].dateAt(e),o[0].dateAt(t)],a.domain([u(r[0]),u(r[1])]),d()})},c.remove=function(){return d3.select("#"+s).selectAll("svg").remove()},c.active=function(t){return t?(e=t,c):e},d3.rebind(c,t,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},n.yaxis=function(){var e,t,n,r,i,s,o,u,a,f,l,h=this;return t=this,u=t.w()*c.w,r=t.h()*c.h,o=d3.scale.linear().range([r,0]),e=d3.svg.axis().scale(o),s=[],n=[],f=null,a=null,i=null,l=function(h){var p,d;i=h.attr("id"),s=h.datum(),e.ticks(Math.floor(r/50,0,0)),e.tickSize(5,3,0),d=function(){var i,c;return n=t.utility().getExtent(s,f,a),o.domain([n[0],n[1]]),l.remove(),c=h.append("svg"),c.attr("width",u),c.attr("height","100%"),i=c.append("g"),i.attr("transform","translate("+(u-1)+", 0)"),i.attr("width",u),i.attr("height",r),i.call(e)},p=function(){return a=s[0].length()-1,f=Math.floor(s[0].length()*t.endPercent())},p(),d(),t.on("toggle.y-axis-"+i,function(){return d()}),t.on("refresh.y-axis-"+i,function(){return s=h.datum(),p(),d()}),t.on("respond.y-axis-"+i,function(){return u=t.w()*c.w,r=t.h()*c.h,e.ticks(Math.floor(r/50,0,0)),o.range([r,0]),d()}),t.on("adjust.y-axis-"+i+"}",function(e,t){return f=e>0?e:0,a=t<s[0].length()?t:s[0].length(),d()})},l.remove=function(e){return d3.select("#"+i).selectAll("svg").remove()},d3.rebind(l,e,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},n.legend=function(){var e,t,n,r;return e=this,n=null,r=[],t=function(t){var i=this;return r=t.datum(),t.selectAll("li").remove(),n=t.selectAll("li").data(r).enter().append("li").append("a").attr("href","javascript:;").attr("data-line-id",function(e){return e.id()}).attr("style",function(t){return"background-color: "+e.utility().getColor(t.id())}).text(function(e){return e.name()}),e.on("refresh.legend",function(){return r=t.datum()}),t.selectAll("a").on("click",function(t,n){var i,s,o;i=d3.event,s=i.target,o=s.getAttribute("data-line-id"),i.preventDefault(),r[o]!=null&&(r[o].toggle()===!1?$(s).addClass("off").attr("style","background-color: none;"):$(s).removeClass("off").attr("style","background-color: "+e.utility().getColor(o)),e.toggle())})},t},n.utility=function(){var e,t=this;return this.context=this,e=function(){},e.createLines=function(e){var n,r,i,s,o,u,a;r=e.columns.slice(1),s=_.map(r,function(t,n){return _.map(e.data,function(e){return{date:e[0],num:+e[n+1]}})});if(!t.context.lines().length)o=_.map(r,function(e,n){return t.context.line({name:e,values:s[n]})});else{o=t.context.lines();for(n=u=0,a=o.length;u<a;n=++u)i=o[n],i.values(s[n])}return o},e.getExtent=function(e,t,n){var r,i;return r=function(){var r,s,o;o=[];for(r=0,s=e.length;r<s;r++)i=e[r],o.push(i.extent(t,n));return o}(),[d3.min(r,function(e){return e[0]}),d3.max(r,function(e){return e[1]})]},e.getColor=function(e){var n;return n=t.context.colorScale(),n(e)},e.getPixelRGB=function(e,t){var n,r;return n=t.getImageData(e[0],e[1],1,1).data,r=d3.rgb(n[0],n[1],n[2]),r.toString()},e.dateFormat=function(e){var t,n;n=e.split("-").length-1;switch(n){case-1:t="%Y";break;case 2:t="%Y-%m-%d";break;default:throw"Unknown date format: "+n+" "+e}return t},e.parseDate=function(e){var t;return t=this.dateFormat(e),d3.time.format(t).parse},e}}).call(this)})(this);