(function(e){(function(){var t,n,r,i,s,o,u,a,f,l,c;i=e.quandlism={version:"0.2.0"},i.context=function(){var e,n,r,i,s,o,u,a,f,l,c,h,p,d,v=this;return n=new t,d=null,l=null,r=null,o=null,i=null,s=null,u=null,a=.8,h=0,p=.75,f=d3.dispatch("respond","adjust","toggle","refresh"),e=d3.scale.category20(),c=[],n.attachData=function(e){return c=e,o&&d3.select(o).datum(c),i&&d3.select(i).datum(c),s&&d3.select(s).datum(c),n},n.render=function(){return o&&d3.select(o).call(n.stage()),i&&d3.select(i).call(n.brush()),s&&d3.select(s).call(n.legend()),n},n.build=function(){return d=$(r).width(),l=$(r).height(),n},n.lines=function(e){return e==null?c:(c=e,n)},n.colorScale=function(t){return t==null?e:(e=t,n)},n.endPercent=function(e){return e==null?a:(a=e,n)},n.startPoint=function(e){return e==null?p:(p=e,n)},n.w=function(e){return e==null?d:(d=e,n)},n.h=function(e){return e==null?l:(l=e,n)},n.dom=function(e){return e==null?r:(r=e,n)},n.domstage=function(e){return e==null?o:(o=e,n)},n.dombrush=function(e){return e==null?i:(i=e,n)},n.domlegend=function(e){return e==null?s:(s=e,n)},n.domtooltip=function(e){return e==null?u:(u=e,n)},n.padding=function(e){return e==null?h:(h=e,n)},n.respond=_.throttle(function(){return f.respond.call(n,500)}),n.adjust=function(e,t){return f.adjust.call(n,e,t)},n.toggle=function(){return f.toggle.call(n)},n.refresh=function(){return f.refresh.call(n)},n.on=function(e,t){return t==null?f.on(e):(f.on(e,t),n)},d3.select(window).on("resize",function(){var e,t;d3.event.preventDefault();if(r){t=$(r).width(),e=$(r).height();if(d!==t||l!==e)d=t,l=e,n.respond()}}),n},t=function(){function e(){}return e}(),n=t.prototype=i.context.prototype,s=0,a=0,u=0,c=50,l={h:.1},o={h:.15},f={h:.65},r=function(){function e(){}return e}(),n.line=function(e){var t,n,i,s,o,u,f=this;return i=new r(t),t=this,s=e.name,o=e.values.reverse(),n=a++,u=!0,i.extent=function(e,t){var n,r,i,s,o;n=e!=null?e:0,s=t!=null?t:this.length()-1,i=Infinity,r=-Infinity;if(!this.visible())return[i,r];while(n<=s){o=this.valueAt(n);if(o==null){n++;continue}o<i&&(i=o),o>r&&(r=o),n++}return[i,r]},i.dates=function(e,t){var n,r,i,s,u;s=o.slice(e,t+1||9e9),u=[];for(r=0,i=s.length;r<i;r++)n=s[r],u.push(n.date);return u},i.length=function(){return o.length},i.valueAt=function(e){return o[e]!=null?o[e].num:null},i.dateAt=function(e){return o[e]!=null?o[e].date:null},i.drawPoint=function(e,t,n,r,i,s){if(this.visible())return t.beginPath(),t.arc(n(i),r(this.valueAt(i)),s,0,Math.PI*2,!0),t.fillStyle=e,t.fill(),t.closePath()},i.drawPath=function(e,t,n,r,i,s,o){var u,a;if(this.visible()){t.beginPath();for(u=a=i;i<=s?a<=s:a>=s;u=i<=s?++a:--a)t.lineTo(n(u),r(this.valueAt(u)));return t.lineWidth=o,t.strokeStyle=e,t.stroke(),t.closePath()}},i.toggle=function(){var e;return e=!this.visible(),this.visible(e),e},i.id=function(e){return e==null?n:(n=e,i)},i.name=function(e){return e==null?s:(s=e,i)},i.values=function(e){return e==null?o:(o=e,i)},i.visible=function(e){return e==null?u:(u=e,i)},i},n.stage=function(){var e,t,n,r,i,s,o,a,h,p,d,v,m,g,y,b,w,E,S,x=this;return n=this,t=null,o=[],p=Math.floor(n.w()-c),s=Math.floor(n.h()*f.h),y=d3.scale.linear(),m=d3.time.scale(),S=d3.scale.linear(),d=d3.svg.axis().orient("bottom").scale(m),w=d3.svg.axis().orient("left").scale(S),E=null,v=null,i=[],b=0,g=p,h=10,e=null,r=null,a=function(a){var x,T,N,C,k,L;o=a.datum(),t="canvas-stage-"+ ++u,E==null&&(E=a.insert("svg"),E.attr("class","y axis"),E.attr("id","y-axis-"+t),E.attr("width",c),E.attr("height",n.h()*f.h)),e=a.append("canvas"),e.attr("width",p),e.attr("height",s),e.attr("class","stage"),e.attr("id",t),r=e.node().getContext("2d"),v==null&&(v=a.append("svg"),v.attr("class","x axis"),v.attr("id","x-axis-"+t),v.attr("width",n.w()-c),v.attr("height",n.h()*l.h),v.attr("style","margin-left: "+c)),w.tickSize(5,3,0),w.ticks(Math.floor(n.h()*f.h/40)),d.tickSize(5,3,0),d.ticks(5),d.tickFormat(d3.time.format("%b %d, %Y")),L=function(){var e,t,r;i=n.utility().getExtent(o,b,g),t=n.utility().parseDate(o[0].dateAt(0)),S.domain([i[0],i[1]]),S.range([s-n.padding(),n.padding()]),y.domain([b,g]),y.range([n.padding(),p-n.padding()]),m.domain([t(o[0].dateAt(b)),t(o[0].dateAt(g))]),m.range([n.padding(),p-n.padding()]),r=n.utility().getUnit(Math.round(i[1])),e=1,r==="K"&&(e=1e3),r==="M"&&(e=1e6),w.tickFormat(function(t){var n;return n=(t/e).toFixed(2),n=n.replace(/0+$/,""),n=n.replace(/\.$/,""),""+n+" "+r})},N=function(){var e,t;return E.selectAll("*").remove(),t=E.append("g"),t.attr("transform","translate("+(c-1)+", 10)"),t.call(w),v.selectAll("*").remove(),e=v.append("g"),e.call(d)},T=function(e){var t,i,u,a,f,l,c;N(),r.clearRect(0,0,p,s),e=e!=null?e:-1;for(i=f=0,c=o.length;f<c;i=++f){u=o[i],a=i===e?3:1.5;if(g-b<=h){u.drawPath(n.utility().getColor(i),r,y,S,b,g,a);for(t=l=b;b<=g?l<=g:l>=g;t=b<=g?++l:--l)u.drawPoint(n.utility().getColor(i),r,y,S,t,3)}else g===b?u.drawPoint(n.utility().getColor(i),r,y,S,b,3):u.drawPath(n.utility().getColor(i),r,y,S,b,g,a)}},k=function(e){var t,i,s,u,a,f,l,c,h,p,d,v,m,g;t=n.utility().getPixelRGB(e,r),s=_.indexOf(n.colorScale().range(),t);if(s!==-1)return{x:e[0],color:t,line:o[s]};i=[];for(u=l=p=e[0]-3,d=e[0]+3;p<=d?l<=d:l>=d;u=p<=d?++l:--l)for(a=c=v=e[1]-3,m=e[1]+3;v<=m?c<=m:c>=m;a=v<=m?++c:--c)(u!==e[0]||a!==e[1])&&i.push([u,a]);for(f=h=0,g=i.length-1;0<=g?h<=g:h>=g;f=0<=g?++h:--h){t=n.utility().getPixelRGB(i[f],r),s=_.indexOf(n.colorScale().range(),t);if(s!==-1)return{x:i[f][0],color:t,line:o[s]}}return!1},C=function(e,t,i){var s;$(n.domtooltip()).html("<span style='color: "+i+";'>"+t.name()+"</span>: "+n.utility().formatNumberAsString(t.valueAt(e))+"  on "+t.dateAt(e)),T(t.id()),s=g-b<=h?5:3,t.drawPoint(i,r,y,S,e,s)},x=function(){$(n.domtooltip()).text(""),T()},n.dombrush()||L()&&T(),n.on("respond.stage",function(){r.clearRect(0,0,p,s),p=Math.floor(n.w()-c),s=Math.floor(n.h()*f.h),e.attr("width",p),e.attr("height",s),E.attr("width",c),v.attr("width",Math.floor(n.w()-c)),v.attr("style","margin-left: "+c),L(),T()}),n.on("adjust.stage",function(e,t){b=e>0?e:0,g=o[0].length()>t?t:o[0].length()-1,L(),T()}),n.on("toggle.stage",function(){L(),T()}),n.on("refresh.stage",function(){o=a.datum(),n.dombrush()||T()}),n.domtooltip()!=null&&d3.select("#"+t).on("mousemove",function(e){var t;t=k(d3.mouse(this)),t!==!1?C(Math.round(y.invert(t.x)),t.line,t.color):x()})},a.canvasId=function(e){return e==null?t:(t=e,a)},a.width=function(e){return e==null?p:(p=e,a)},a.height=function(e){return e==null?s:(s=e,a)},a.xScale=function(e){return e==null?y:(y=e,a)},a.yScale=function(e){return e==null?S:(S=e,a)},a.xEnd=function(e){return e==null?g:(g=e,a)},a.xStart=function(e){return e==null?b:(b=e,a)},a.threshold=function(e){return e==null?h:(h=e,a)},a},n.brush=function(){var e,t,n,r,i,s,a,f,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D=this;return a=this,m=a.h()*o.h,g=m,T=a.w()-c,N=T,n=null,r=null,v=10,O=null,M=null,A=d3.scale.linear(),L=d3.time.scale(),_=d3.scale.linear(),i=null,f=null,C=d3.svg.axis().orient("bottom").scale(L),k=null,s=null,d=[],y=[],S=10,p=!1,h=!0,E=!1,b=6,w=0,e=0,x=null,t=function(t){var D,P,H,B,j,F,I,q,R,U;return y=t.datum(),s="canvas-brush-"+ ++u,i=t.append("canvas").attr("id",s),f=i.node().getContext("2d"),k==null&&(k=t.append("svg"),k.attr("class","x axis"),k.attr("id","x-axis-"+s),k.attr("height",a.h()*l.h),k.attr("width",a.w()-c)),C.tickSize(5,3,0),$(""+a.dombrush()).css("marginLeft",""+c+"px"),R=function(){var e;d=a.utility().getExtent(y,null,null),e=a.utility().parseDate(y[0].dateAt(0)),_.domain([d[0],d[1]]),_.range([m-a.padding(),a.padding()]),A.domain([0,y[0].length()-1]),A.range([a.padding(),T-a.padding()]),L.range([a.padding(),T-a.padding()]),L.domain([e(y[0].dateAt(0)),e(y[0].dateAt(y[0].length()-1))]),w=Math.floor(A(b))},q=function(){O=A(a.startPoint()*y[0].length()),M=O,n=T-O,r=n,n<w&&(n=w,r=n,O=T-n,M=O)},U=function(){P(),B(),F()},P=function(){f.clearRect(0,0,N,g),i.attr("width",T).attr("height",m)},j=function(){var e;return k.selectAll("*").remove(),e=k.append("g"),e.call(C)},B=function(){var e,t,n,r,i;n=y[0].length()<=S;for(e=r=0,i=y.length;r<i;e=++r)t=y[e],t.drawPath(a.utility().getColor(e),f,A,_,0,y[0].length(),1),n&&t.drawPoint(a.utility().getColor(e),f,A,_,e,2)},F=function(){f.strokeStyle="rgba(207, 207, 207, 0.55)",f.beginPath(),f.fillStyle="rgba(207, 207, 207, 0.55)",f.fillRect(O,0,n,m),f.lineWidth=1,f.lineTo(O,m),f.closePath(),f.beginPath(),f.fillStyle="#CFCFCF",f.fillRect(O-v,0,v,m),f.closePath(),f.beginPath(),f.fillStyle="#CFCFCF",f.fillRect(O+n,0,v,m),f.closePath()},D=function(){return y[0].length()-1<=b?(O=0,r=T,n=T,h=!1):h=!0},H=function(){var e,t;e=A.invert(O),t=A.invert(O+n),a.adjust(Math.ceil(e),Math.ceil(t))},I=function(){p=!1,E=!1,e=0,M=O,r=n},R(),D(),h&&q(),j(),H(),setInterval(U,50),a.on("respond.brush",function(){g=m,N=T,m=a.h()*o.h,T=a.w()-c,O=O/N*T,M=M/N*T,n=n/N*T,r=n,k.attr("width",T),$(""+a.dombrush()).css("marginLeft",""+c+"px"),R(),j()}),a.on("refresh.brush",function(){y=t.datum(),R(),D(),h&&q(),H()}),a.on("toggle.brush",function(){R()}),i.on("mousedown",function(t){var r;d3.event.preventDefault(),r=d3.mouse(this),x=r[0],r[0]>=O-v&&r[0]<O?(E=!0,e=-1):r[0]>O+n&&r[0]<=O+n+v?(E=!0,e=1):r[0]<=n+O&&r[0]>=O&&(p=!0)}),i.on("mouseup",function(e){I()}),i.on("mouseout",function(e){I()}),i.on("mousemove",function(t){var i,s;s=d3.mouse(this);if(p||E){i=s[0]-x;if(p&&h)O=M+i;else if(E){if(e!==0&&e!==-1&&e!==1)throw"Error: Unknown stretching direction";n=e===-1?r-i:r+i,e===-1&&(O=M+i),n<=w&&(e===-1&&(O+=n-w),n=w)}H()}})},t.xAxis=function(e){return e==null?C:(C=e,t)},t.threshold=function(e){return e==null?S:(S=e,t)},t.stretchLimit=function(e){return e==null?b:(b=e,t)},t.handleWidth=function(e){return e==null?v:(v=e,t)},t},n.xaxis=function(){var e,t,n,r,i,s,o,u,a,f,c,h=this;return n=this,f=n.w()*l.w,i=n.h()*l.h,a=d3.time.scale().range([0,f]),t=d3.svg.axis().scale(a),r=[],e=!1,o=[],s=null,u=null,c=function(h){var p,d;s=h.attr("id"),o=h.datum(),t.tickSize(5,3,0),d=function(){var e;return c.remove(),e=h.append("svg"),e.attr("width",f),e.attr("height",i),e.append("g"),e.attr("transform","translate(0, 27)"),e.call(t)},p=function(){return r=[o[0].dateAt(0),o[0].dateAt(o[0].length()-1)],u=n.utility().parseDate(o[0].dateAt(0)),a.domain([u(r[0]),u(r[1])]),t.tickFormat(d3.time.format("%b %d, %Y")),t.ticks(Math.floor(f/150,0,0)),a.range([0,f])},p(),d(),n.on("respond.xaxis-"+s,function(){return f=n.w()*l.w,t.ticks(Math.floor(f/150,0,0)),a.range([0,f]),d()}),n.on("refresh.xaxis-"+s,function(){return o=h.datum(),p(),d()}),e&&n.on("adjust.xaxis-"+s,function(e,t){return t=t>o[0].length()-1?o[0].length()-1:t,e=e<0?0:e,r=[o[0].dateAt(e),o[0].dateAt(t)],a.domain([u(r[0]),u(r[1])]),d()})},c.remove=function(){return d3.select("#"+s).selectAll("svg").remove()},c.active=function(t){return t?(e=t,c):e},d3.rebind(c,t,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},n.yaxis=function(){var e,t,n,r,i,s,o,u,a,f,l,c=this;return t=this,u=t.w()*quandlism_yaxis.w,r=t.h()*quandlism_yaxis.h,o=d3.scale.linear().range([r,0]),e=d3.svg.axis().scale(o),s=[],n=[],f=null,a=null,i=null,l=function(c){var h,p;i=c.attr("id"),s=c.datum(),e.ticks(Math.floor(r/25,0,0)),e.tickSize(5,3,0),p=function(){var i,h;return n=t.utility().getExtent(s,f,a),o.domain([n[0],n[1]]),l.remove(),h=c.append("svg"),h.attr("width",u),h.attr("height","100%"),i=h.append("g"),i.attr("transform","translate("+(u-1)+", 0)"),i.attr("width",u),i.attr("height",r),i.call(e)},h=function(){a=s[0].length()-1,f=Math.floor(s[0].length()*t.endPercent())},h(),p(),t.on("toggle.y-axis-"+i,function(){p()}),t.on("refresh.y-axis-"+i,function(){s=c.datum(),h(),p()}),t.on("respond.y-axis-"+i,function(){u=t.w()*quandlism_yaxis.w,r=t.h()*quandlism_yaxis.h,e.ticks(Math.floor(r/25,0,0)),o.range([r,0]),p()}),t.on("adjust.y-axis-"+i+"}",function(e,t){f=e>0?e:0,a=t<s[0].length()?t:s[0].length(),p()})},l.remove=function(e){d3.select("#"+i).selectAll("svg").remove()},d3.rebind(l,e,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},n.legend=function(){var e,t,n,r;return e=this,n=null,r=[],t=function(t){var i=this;return r=t.datum(),t.selectAll("li").remove(),n=t.selectAll("li").data(r).enter().append("li").append("a").attr("href","javascript:;").attr("data-line-id",function(e){return e.id()}).attr("style",function(t){return"background-color: "+e.utility().getColor(t.id())}).text(function(e){return e.name()}),e.on("refresh.legend",function(){return r=t.datum()}),t.selectAll("a").on("click",function(t,n){var i,s,o;i=d3.event,s=i.target,o=s.getAttribute("data-line-id"),i.preventDefault(),r[o]!=null&&(r[o].toggle()===!1?$(s).addClass("off").attr("style","background-color: none;"):$(s).removeClass("off").attr("style","background-color: "+e.utility().getColor(o)),e.toggle())})},t},n.utility=function(){var e,t,n=this;return e=this,t=function(){},t.createLines=function(t){var n,r,i,s,o,u,a;r=t.columns.slice(1),s=_.map(r,function(e,n){return _.map(t.data,function(e){return{date:e[0],num:+e[n+1]}})});if(!e.lines().length)o=_.map(r,function(t,n){return e.line({name:t,values:s[n]})});else{o=e.lines();for(n=u=0,a=o.length;u<a;n=++u)i=o[n],i.values(s[n].reverse())}return o},t.getExtent=function(e,t,n){var r,i;return r=function(){var r,s,o;o=[];for(r=0,s=e.length;r<s;r++)i=e[r],o.push(i.extent(t,n));return o}(),[d3.min(r,function(e){return e[0]}),d3.max(r,function(e){return e[1]})]},t.getColor=function(t){var n;return n=e.colorScale(),n(t)},t.formatNumberAsString=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},t.getPixelRGB=function(e,t){var n,r;return n=t.getImageData(e[0],e[1],1,1).data,r=d3.rgb(n[0],n[1],n[2]),r.toString()},t.getUnit=function(e){var t;return t=e.toString().length,t<=3?"":t<=6?"K":"M"},t.dateFormat=function(e){var t,n;n=e.split("-").length-1;switch(n){case-1:t="%Y";break;case 2:t="%Y-%m-%d";break;default:throw"Unknown date format: "+n+" "+e}return t},t.parseDate=function(e){var t;return t=this.dateFormat(e),d3.time.format(t).parse},t}}).call(this)})(this);