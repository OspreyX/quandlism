(function(e){(function(){var t,n,r,i,s,o,u,a,f,l,c;i=e.quandlism={version:"0.2.0"},i.context=function(){var e,n,r,i,s,o,u,a,f,l,c,h,p=this;return n=new t,h=null,l=null,r=null,o=null,i=null,s=null,u=null,a=.8,f=d3.dispatch("respond","adjust","toggle","refresh"),e=d3.scale.category20(),c=[],n.attachData=function(e){var t,r;return c=e,o&&(r=d3.select(o).datum(c)),r&&r.select(".x")&&r.select(".x").datum(c),r&&r.select(".y")&&r.select(".y").datum(c),i&&(t=d3.select(i).datum(c)),t&&t.select(".x")&&t.select(".x").datum(c),s&&d3.select(s).datum(c),n},n.render=function(){return o&&d3.select(o).call(n.stage()),i&&d3.select(i).call(n.brush()),s&&d3.select(s).call(n.legend()),n},n.build=function(){return h=$(r).width(),l=$(r).height(),n},n.lines=function(e){return e==null?c:(c=e,n)},n.colorScale=function(t){return t==null?e:(e=t,n)},n.endPercent=function(e){return e==null?a:(a=e,n)},n.w=function(e){return e==null?h:(h=e,n)},n.h=function(e){return e==null?l:(l=e,n)},n.dom=function(e){return e==null?r:(r=e,n)},n.domstage=function(e){return e==null?o:(o=e,n)},n.dombrush=function(e){return e==null?i:(i=e,n)},n.domlegend=function(e){return e==null?s:(s=e,n)},n.domtooltip=function(e){return e==null?u:(u=e,n)},n.respond=_.throttle(function(){return f.respond.call(n,500)}),n.adjust=function(e,t){return f.adjust.call(n,e,t)},n.toggle=function(){return f.toggle.call(n)},n.refresh=function(){return f.refresh.call(n)},n.on=function(e,t){return t==null?f.on(e):(f.on(e,t),n)},d3.select(window).on("resize",function(){var e,t;d3.event.preventDefault();if(r){t=$(r).width(),e=$(r).height();if(h!==t||l!==e)h=t,l=e,n.respond()}}),n},t=function(){function e(){}return e}(),n=t.prototype=i.context.prototype,s=0,a=0,u=0,f={w:.87,h:.6},o={w:.87,h:.1},l={w:.87,h:.15},c={w:.12,h:.6},r=function(){function e(){}return e}(),n.line=function(e){var t,n,i,s,o,u,f=this;return i=new r(t),t=this,s=e.name,o=e.values.reverse(),n=a++,u=!0,i.extent=function(e,t){var n,r,i,s,o;n=e!=null?e:0,s=t!=null?t:this.length()-1,i=Infinity,r=-Infinity;if(!this.visible())return[i,r];while(n<=s){o=this.valueAt(n);if(o==null){n++;continue}o<i&&(i=o),o>r&&(r=o),n++}return[i,r]},i.length=function(){return o.length},i.valueAt=function(e){return o[e]!=null?o[e].num:null},i.dateAt=function(e){return o[e]!=null?o[e].date:null},i.drawPoint=function(e,t,n,r,i,s){if(this.visible())return t.beginPath(),t.arc(n(i),r(this.valueAt(i)),s,0,Math.PI*2,!0),t.fillStyle=e,t.fill(),t.closePath()},i.drawPath=function(e,t,n,r,i,s,o){var u,a;if(this.visible()){t.beginPath();for(u=a=i;i<=s?a<=s:a>=s;u=i<=s?++a:--a)t.lineTo(n(u),r(this.valueAt(u)));return t.lineWidth=o,t.strokeStyle=e,t.stroke(),t.closePath()}},i.toggle=function(){var e;return e=!this.visible(),this.visible(e),e},i.id=function(e){return e==null?n:(n=e,i)},i.name=function(e){return e==null?s:(s=e,i)},i.values=function(e){return e==null?o:(o=e,i)},i.visible=function(e){return e==null?u:(u=e,i)},i},n.stage=function(){var e,t,n,r,i,s,o,a,h,p,d,v,m,g,y,b,w,E=this;return n=this,t=null,o=[],d=Math.floor(n.w()*f.w),s=Math.floor(n.h()*f.h),g=d3.scale.linear(),w=d3.scale.linear(),v=null,b=null,a=10,i=[],y=null,m=null,p=10,e=null,r=null,h=function(h){var E,S,x,T;o=h.datum(),t="canvas-stage-"+ ++u,b==null&&(b=h.append("div"),b.datum(o),b.attr("height",n.h()*c.h),b.attr("width",n.w()*c.w),b.attr("class","axis y"),b.attr("id","y-axis-"+t),b.call(n.yaxis().orient("left"))),e=h.append("canvas"),e.attr("width",d),e.attr("height",s),e.attr("class","stage"),e.attr("id",t),r=e.node().getContext("2d"),v==null&&(v=h.append("div"),v.datum(o),v.attr("width",n.w()*l.w),v.attr("height",n.h()*l.h),v.attr("class","x axis"),v.attr("id","x-axis-"+t),v.call(n.xaxis().active(!0))),y=y?y:Math.floor(o[0].length()*n.endPercent()),m=m?m:o[0].length(),S=function(e){var t,u,f,l,c,h,v;i=n.utility().getExtent(o,y,m),w.domain([i[0],i[1]]),w.range([s-a,a]),g.domain([y,m]),g.range([a,d-a]),r.clearRect(0,0,d,s),e=e!=null?e:-1;for(u=c=0,v=o.length;c<v;u=++c){f=o[u],l=u===e?3:1.5;if(m-y<=p){f.drawPath(n.utility().getColor(u),r,g,w,y,m,l);for(t=h=y;y<=m?h<=m:h>=m;t=y<=m?++h:--h)f.drawPoint(n.utility().getColor(u),r,g,w,t,3)}else m===y?f.drawPoint(n.utility().getColor(u),r,g,w,y,3):f.drawPath(n.utility().getColor(u),r,g,w,y,m,l)}},T=function(e){var t,i,s,u,a,f,l,c,h,p,d,v,m,g;t=n.utility().getPixelRGB(e,r),s=_.indexOf(n.colorScale().range(),t);if(s!==-1)return{x:e[0],color:t,line:o[s]};i=[];for(u=l=p=e[0]-3,d=e[0]+3;p<=d?l<=d:l>=d;u=p<=d?++l:--l)for(a=c=v=e[1]-3,m=e[1]+3;v<=m?c<=m:c>=m;a=v<=m?++c:--c)(u!==e[0]||a!==e[1])&&i.push([u,a]);for(f=h=0,g=i.length-1;0<=g?h<=g:h>=g;f=0<=g?++h:--h){t=n.utility().getPixelRGB(i[f],r),s=_.indexOf(n.colorScale().range(),t);if(s!==-1)return{x:i[f][0],color:t,line:o[s]}}return!1},x=function(e,t,i){var s;$(n.domtooltip()).html("<span style='color: "+i+";'>"+t.name()+"</span>: "+n.utility().formatNumberAsString(t.valueAt(e))+"  on "+t.dateAt(e)),S(t.id()),s=m-y<=p?5:3,t.drawPoint(i,r,g,w,e,s)},E=function(){$(n.domtooltip()).text(""),S()},S(),n.on("respond.stage",function(){r.clearRect(0,0,d,s),d=Math.floor(n.w()*f.w),s=Math.floor(n.h()*f.h),e.attr("width",d),e.attr("height",s),S()}),n.on("adjust.stage",function(e,t){y=e>0?e:0,m=o[0].length()>2?t:o[0].length()-1,S()}),n.on("toggle.stage",function(){S()}),n.on("refresh.stage",function(){o=h.datum(),m=o[0].length(),y=Math.floor(o[0].length()*n.endPercent()),S()}),n.domtooltip()!=null&&d3.select("#"+t).on("mousemove",function(e){var t;return t=T(d3.mouse(this)),t!==!1?x(Math.round(g.invert(t.x)),t.line,t.color):E()})},h.padding=function(e){return e==null?a:(a=e,h)},h.canvasId=function(e){return e==null?t:(t=e,h)},h.width=function(e){return e==null?d:(d=e,h)},h.height=function(e){return e==null?s:(s=e,h)},h.xScale=function(e){return e==null?g:(g=e,h)},h.yScale=function(e){return e==null?w:(w=e,h)},h.xEnd=function(e){return e==null?m:(m=e,h)},h.xStart=function(e){return e==null?y:(y=e,h)},h.threshold=function(e){return e==null?p:(p=e,h)},h},n.brush=function(){var e,t,n,r,i,s,a,f,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O=this;return a=this,v=a.h()*o.h,m=v,x=a.w()*o.w,T=x,n=Math.ceil(x*.2),r=n,d=10,k=x*a.endPercent(),L=k,C=d3.scale.linear(),A=d3.scale.linear(),i=null,f=null,N=null,s=null,p=[],g=[],E=10,h=!1,c=!0,w=!1,y=6,b=0,e=0,S=null,t=function(t){var O,M,_,D,P,H,B,j;return g=t.datum(),s="canvas-brush-"+ ++u,i=t.append("canvas").attr("width",x).attr("height",v).attr("class","brush").attr("id",s),f=i.node().getContext("2d"),N==null&&(N=t.append("div"),N.datum(g),N.attr("class","x axis"),N.attr("width",a.w()*l.w),N.attr("height",a.h()*l.h),N.attr("id","x-axis-"+s),N.call(a.xaxis())),B=function(){p=a.utility().getExtent(g,null,null),A.domain([p[0],p[1]]),A.range([v,0]),C.domain([0,g[0].length()-1]),C.range([0,x]),b=Math.floor(C(y))},j=function(){M(),D(),P()},M=function(){f.clearRect(0,0,T,m),i.attr("width",x).attr("height",v)},D=function(){var e,t,n,r,i;n=g[0].length()<=E;for(e=r=0,i=g.length;r<i;e=++r)t=g[e],t.drawPath(a.utility().getColor(e),f,C,A,0,g[0].length(),1),n&&t.drawPoint(a.utility().getColor(e),f,C,A,e,2)},P=function(){f.strokeStyle="rgba(207, 207, 207, 0.55)",f.beginPath(),f.fillStyle="rgba(207, 207, 207, 0.55)",f.fillRect(k,0,n,v),f.lineWidth=1,f.lineTo(k,v),f.closePath(),f.beginPath(),f.fillStyle="#CFCFCF",f.fillRect(k-d,0,d,v),f.closePath(),f.beginPath(),f.fillStyle="#CFCFCF",f.fillRect(k+n,0,d,v),f.closePath()},O=function(){return g[0].length()-1<=y?(k=0,r=x,n=x,c=!1):c=!0},_=function(){var e,t;e=C.invert(k),t=C.invert(k+n),a.adjust(Math.ceil(e),Math.ceil(t))},H=function(){h=!1,w=!1,e=0,L=k,r=n},B(),O(),_(),setInterval(j,50),a.on("respond.brush",function(){m=v,T=x,v=a.h()*o.h,x=a.w()*o.w,k=c?Math.ceil(k/T*x):0,L=c?Math.ceil(L/T*x):k,n=c?Math.ceil(n/T*x):x,r=n,B()}),a.on("refresh.brush",function(){g=t.datum(),k=Math.ceil(x*a.endPercent()),L=k,n=Math.ceil(x*.2),r=n,B()}),a.on("toggle.brush",function(){B()}),i.on("mousedown",function(t){var r;d3.event.preventDefault(),r=d3.mouse(this),S=r[0],r[0]>=k-d&&r[0]<k?(w=!0,e=-1):r[0]>k+n&&r[0]<=k+n+d?(w=!0,e=1):r[0]<=n+k&&r[0]>=k&&(h=!0)}),i.on("mouseup",function(e){H()}),i.on("mouseout",function(e){H()}),i.on("mousemove",function(t){var i,s;s=d3.mouse(this);if(h||w){i=s[0]-S;if(h&&c)k=L+i;else if(w){if(e!==0&&e!==-1&&e!==1)throw"Error: Unknown stretching direction";n=e===-1?r-i:r+i,e===-1&&(k=L+i),n<=b&&(e===-1&&(k+=n-b),n=b)}_()}})},t.xAxis=function(e){return e==null?N:(N=e,t)},t.threshold=function(e){return e==null?E:(E=e,t)},t.stretchLimit=function(e){return e==null?y:(y=e,t)},t.handleWidth=function(e){return e==null?d:(d=e,t)},t},n.xaxis=function(){var e,t,n,r,i,s,o,u,a,f,c,h=this;return n=this,f=n.w()*l.w,i=n.h()*l.h,a=d3.time.scale().range([0,f]),t=d3.svg.axis().scale(a),r=[],e=!1,o=[],s=null,u=null,c=function(h){var p,d;s=h.attr("id"),o=h.datum(),t.tickSize(5,3,0),d=function(){var e;return c.remove(),e=h.append("svg"),e.attr("width",f),e.attr("height",i),e.append("g"),e.attr("transform","translate(0, 27)"),e.call(t)},p=function(){return r=[o[0].dateAt(0),o[0].dateAt(o[0].length()-1)],u=n.utility().parseDate(o[0].dateAt(0)),a.domain([u(r[0]),u(r[1])]),t.tickFormat(d3.time.format("%b %d, %Y")),t.ticks(Math.floor(f/150,0,0)),a.range([0,f])},p(),d(),n.on("respond.xaxis-"+s,function(){return f=n.w()*l.w,t.ticks(Math.floor(f/150,0,0)),a.range([0,f]),d()}),n.on("refresh.xaxis-"+s,function(){return o=h.datum(),p(),d()}),e&&n.on("adjust.xaxis-"+s,function(e,t){return t=t>o[0].length()-1?o[0].length()-1:t,e=e<0?0:e,r=[o[0].dateAt(e),o[0].dateAt(t)],a.domain([u(r[0]),u(r[1])]),d()})},c.remove=function(){return d3.select("#"+s).selectAll("svg").remove()},c.active=function(t){return t?(e=t,c):e},d3.rebind(c,t,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},n.yaxis=function(){var e,t,n,r,i,s,o,u,a,f,l,h=this;return t=this,u=t.w()*c.w,r=t.h()*c.h,o=d3.scale.linear().range([r,0]),e=d3.svg.axis().scale(o),s=[],n=[],f=null,a=null,i=null,l=function(h){var p,d;i=h.attr("id"),s=h.datum(),e.ticks(Math.floor(r/50,0,0)),e.tickSize(5,3,0),d=function(){var i,c;return n=t.utility().getExtent(s,f,a),o.domain([n[0],n[1]]),l.remove(),c=h.append("svg"),c.attr("width",u),c.attr("height","100%"),i=c.append("g"),i.attr("transform","translate("+(u-1)+", 0)"),i.attr("width",u),i.attr("height",r),i.call(e)},p=function(){a=s[0].length()-1,f=Math.floor(s[0].length()*t.endPercent())},p(),d(),t.on("toggle.y-axis-"+i,function(){d()}),t.on("refresh.y-axis-"+i,function(){s=h.datum(),p(),d()}),t.on("respond.y-axis-"+i,function(){u=t.w()*c.w,r=t.h()*c.h,e.ticks(Math.floor(r/50,0,0)),o.range([r,0]),d()}),t.on("adjust.y-axis-"+i+"}",function(e,t){f=e>0?e:0,a=t<s[0].length()?t:s[0].length(),d()})},l.remove=function(e){d3.select("#"+i).selectAll("svg").remove()},d3.rebind(l,e,"orient","ticks","ticksSubdivide","tickSize","tickPadding","tickFormat")},n.legend=function(){var e,t,n,r;return e=this,n=null,r=[],t=function(t){var i=this;return r=t.datum(),t.selectAll("li").remove(),n=t.selectAll("li").data(r).enter().append("li").append("a").attr("href","javascript:;").attr("data-line-id",function(e){return e.id()}).attr("style",function(t){return"background-color: "+e.utility().getColor(t.id())}).text(function(e){return e.name()}),e.on("refresh.legend",function(){return r=t.datum()}),t.selectAll("a").on("click",function(t,n){var i,s,o;i=d3.event,s=i.target,o=s.getAttribute("data-line-id"),i.preventDefault(),r[o]!=null&&(r[o].toggle()===!1?$(s).addClass("off").attr("style","background-color: none;"):$(s).removeClass("off").attr("style","background-color: "+e.utility().getColor(o)),e.toggle())})},t},n.utility=function(){var e,t,n=this;return e=this,t=function(){},t.createLines=function(t){var n,r,i,s,o,u,a;r=t.columns.slice(1),s=_.map(r,function(e,n){return _.map(t.data,function(e){return{date:e[0],num:+e[n+1]}})});if(!e.lines().length)o=_.map(r,function(t,n){return e.line({name:t,values:s[n]})});else{o=e.lines();for(n=u=0,a=o.length;u<a;n=++u)i=o[n],i.values(s[n].reverse())}return o},t.getExtent=function(e,t,n){var r,i;return r=function(){var r,s,o;o=[];for(r=0,s=e.length;r<s;r++)i=e[r],o.push(i.extent(t,n));return o}(),[d3.min(r,function(e){return e[0]}),d3.max(r,function(e){return e[1]})]},t.getColor=function(t){var n;return n=e.colorScale(),n(t)},t.formatNumberAsString=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},t.getPixelRGB=function(e,t){var n,r;return n=t.getImageData(e[0],e[1],1,1).data,r=d3.rgb(n[0],n[1],n[2]),r.toString()},t.dateFormat=function(e){var t,n;n=e.split("-").length-1;switch(n){case-1:t="%Y";break;case 2:t="%Y-%m-%d";break;default:throw"Unknown date format: "+n+" "+e}return t},t.parseDate=function(e){var t;return t=this.dateFormat(e),d3.time.format(t).parse},t}}).call(this)})(this);